(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const a of h.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(i){if(i.ep)return;i.ep=!0;const h=e(i);fetch(i.href,h)}})();function $(n,t="."){console.warn(`${n}${t}`)}function K(n,t="."){console.warn(`${n}${t}`)}const rt="#D55E00",Q=.25;class Ft{constructor(t,e,s,i,h,a,u,d="",c="none",l=!1,r=null){this._homeCanvas=t,this._homeAnim=e,this._otherCanvas=s,this._otherAnim=i,this._duplicateAnim=r,this._otherHidden=l,this._minT=h,this._maxT=a,this._step=u,this._beatStep=this._step,this._xScale=1,Number.isFinite(d)?(this._minX=d,this._minXAuto=!1):(this._minX=-(this._width/2)/this._scale,this._minXAuto=!0),this._maxX=this._width/this._scale+this._minX,this._minVisT=this._minT,this._maxVisT=this._maxT,this._minVisX=this._minX,this._maxVisX=this._maxX,this._otherFrame=c,this._ctxH=this._homeCanvas.getContext("2d"),this._ctxO=this._otherCanvas.getContext("2d"),this._ctxHa=this._homeAnim.getContext("2d"),this._ctxOa=this._otherAnim.getContext("2d"),this._duplicateAnim&&(this._ctxDHa=this._duplicateAnim.getContext("2d")),this._homeBackground=document.createElement("canvas"),this._otherBackground=document.createElement("canvas"),this._ctxHbg=this._homeBackground.getContext("2d"),this._ctxObg=this._otherBackground.getContext("2d"),this._width=480,this._height=360,this._scale=32,this._animHeight=40,this._origin={x:0,y:0},this.setCanvasSizes(),this._timeslice=null}setCoordRange(t,e,s,i=null){this._minT=t,this._maxT=e,this._step=s,this._scale=this._height/(e-t),Number.isFinite(i)?(this._minX=i,this._minXAuto=!1,this._origin={x:-i*this._scale,y:e*this._scale}):(this._origin={x:this._width/2,y:e*this._scale},this._minX=-this._origin.x/this._scale/this._xScale,this._minXAuto=!0),this._maxX=this._width/this._scale/this._xScale+this._minX,this.setFrameBeta(this._otherFrame.getBeta())}setXScale(t){this._xScale=t,this.setCoordRange(this._minT,this._maxT,this._step,this._minX)}setFrameBeta(t){t!==null&&this._otherFrame.setBeta(t),this._minVisT=Math.min(this._minT,this._otherFrame.homeT(this._minT,this._minX),this._otherFrame.homeT(this._minT,this._maxX)),this._minVisX=Math.min(this._minX,this._otherFrame.homeX(this._minT,this._minX),this._otherFrame.homeX(this._maxT,this._minX)),this._maxVisT=Math.max(this._maxT,this._otherFrame.homeT(this._maxT,this._minX),this._otherFrame.homeT(this._maxT,this._maxX)),this._maxVisX=Math.max(this._maxX,this._otherFrame.homeX(this._minT,this._maxX),this._otherFrame.homeX(this._maxT,this._maxX)),this._minVisTO=Math.min(this._minT,this._otherFrame.otherT(this._minT,this._minX),this._otherFrame.otherT(this._minT,this._maxX)),this._minVisXO=Math.min(this._minX,this._otherFrame.otherX(this._minT,this._minX),this._otherFrame.otherX(this._maxT,this._minX)),this._maxVisTO=Math.max(this._maxT,this._otherFrame.otherT(this._maxT,this._minX),this._otherFrame.otherT(this._maxT,this._maxX)),this._maxVisXO=Math.max(this._maxX,this._otherFrame.otherX(this._minT,this._maxX),this._otherFrame.otherX(this._maxT,this._maxX)),this.drawBackground(),this.redraw()}setCanvasSizes(){this._width=this._homeAnim.clientWidth,this._height=this._homeCanvas.clientHeight,this._homeCanvas.width=this._width,this._homeCanvas.height=this._height,this._otherCanvas.width=this._width,this._otherCanvas.height=this._height,this._scale=this._height/(this._maxT-this._minT),this._animHeight=this._homeAnim.clientHeight,this._homeAnim.width=this._width,this._homeAnim.height=this._width/9,this._otherAnim.width=this._width,this._otherAnim.height=this._width/9,this._duplicateAnim&&(this._duplicateAnim.width=this._width,this._duplicateAnim.height=this._width/9),this._homeBackground.width=this._width,this._homeBackground.height=this._height,this._otherBackground.width=this._width,this._otherBackground.height=this._height,this._origin={x:-this._minX*this._scale,y:this._maxT*this._scale},this.setFrameBeta(null)}getOtherFrame(){return this._otherFrame}getHomeCanvas(){return this._homeCanvas}getOtherCanvas(){return this._otherCanvas}getCoordRange(){return{minT:this._minT,maxT:this._maxT,step:this._step,minX:this._minX,maxX:this._maxX,minXAuto:this._minXAuto}}getVisCoordRange(){return{minVisT:this._minVisT,maxVisT:this._maxVisT,minVisX:this._minVisX,maxVisX:this._maxVisX}}getVisOtherCoordRange(){return{minVisTO:this._minVisTO,maxVisTO:this._maxVisTO,minVisXO:this._minVisXO,maxVisXO:this._maxVisXO}}setTimeslice(t){this._timeslice=t}getStep(){return this._step}setHeartbeatStep(t){(!Number.isFinite(t)||t<=0)&&($(`Step ${t} isn't >= 0`,": default to 1."),t=1),this._beatStep=t}getHeartbeatStep(){return this._beatStep}setOtherHidden(t){t?(this._otherHidden=!0,this._otherCanvas.parentElement.classList.add("hidden")):(this._otherHidden=!1,this._otherCanvas.parentElement.classList.remove("hidden"))}getOtherHidden(){return this._otherHidden}redraw(){if(this._ctxH.clearRect(0,0,this._width,this._height),this._ctxO.clearRect(0,0,this._width,this._height),Number.isFinite(this._timeslice)&&this._timeslice>=this._minT&&this._timeslice<=this._maxT){let t=this.toCanvasCoords(this._timeslice,this._minX),e=this.toCanvasCoords(this._timeslice,this._maxX);this._ctxH.strokeStyle="#F0E442",this._ctxH.lineWidth=2,this._ctxO.strokeStyle="#F0E442",this._ctxO.lineWidth=2,this._ctxH.beginPath(),this._ctxH.moveTo(t.px,t.py),this._ctxH.lineTo(e.px,e.py),this._ctxH.stroke(),this._ctxO.beginPath(),this._ctxO.moveTo(t.px,t.py),this._ctxO.lineTo(e.px,e.py),this._ctxO.stroke()}this._ctxH.drawImage(this._homeBackground,0,0),this._ctxO.drawImage(this._otherBackground,0,0)}toCanvasCoords(t,e){return{px:(this._origin.x+e*this._scale)*this._xScale,py:this._origin.y-t*this._scale}}toCanvasCoordsA(t){return this.toCanvasCoords(t[0],t[1])}toCanvasCoordsP(t){return this.toCanvasCoords(t.t,t.x)}toCanvasX(t){return(this._origin.x+t*this._scale)*this._xScale}toOtherCanvasCoords(t,e){if(this._otherFrame==="none")return this.toCanvasCoords(t,e);const s=this._otherFrame.otherT(t,e),i=this._otherFrame.otherX(t,e);return{px:this._origin.x+i*this._scale,py:this._origin.y-s*this._scale}}toOtherCanvasCoordsA(t){return this.toOtherCanvasCoords(t[0],t[1])}toOtherCanvasCoordsP(t){return this.toOtherCanvasCoords(t.t,t.x)}toHomeCoords(t,e,s="home",i=null){let h=(this._origin.y-e)/this._scale,a=(t/this._xScale-this._origin.x)/this._scale;return Number.isFinite(i)&&(h=Math.round(h/i)*i,a=Math.round(a/i)*i),s!=="other"?{t:h,x:a}:{t:this._otherFrame.homeT(h,a),x:this._otherFrame.homeX(h,a)}}drawBackground(){let t,e;this._ctxHbg.clearRect(0,0,this._width,this._height),this._ctxObg.clearRect(0,0,this._width,this._height);const s=this._otherFrame.getBeta()!==0;let i,h;s&&(this._ctxHbg.strokeStyle="rgb(200, 200, 240)",this._ctxHbg.lineWidth=.5,this._otherFrame.otherCoordGrid(this._minT,this._maxT,this._minX,this._maxX,this._step).forEach(_=>{t=this.toCanvasCoordsP(_[0]),this._ctxHbg.beginPath(),this._ctxHbg.moveTo(t.px,t.py),_.slice(1).forEach(v=>{e=this.toCanvasCoordsP(v),this._ctxHbg.lineTo(e.px,e.py),t=e}),this._ctxHbg.stroke()}),i=this._otherFrame.otherCoordAxes(this._minT,this._maxT,this._minX,this._maxX),this._ctxHbg.strokeStyle="rgb(150,150,180)",this._ctxHbg.lineWidth=1,t=this.toCanvasCoordsP(i[0][0]),e=this.toCanvasCoordsP(i[0][1]),this._ctxHbg.beginPath(),this._ctxHbg.moveTo(t.px,t.py),this._ctxHbg.lineTo(e.px,e.py),this._ctxHbg.stroke(),t=this.toCanvasCoordsP(i[1][0]),e=this.toCanvasCoordsP(i[1][1]),this._ctxHbg.beginPath(),this._ctxHbg.moveTo(t.px,t.py),this._ctxHbg.lineTo(e.px,e.py),this._ctxHbg.stroke(),this._ctxObg.strokeStyle="rgb(200, 200, 240)",this._ctxObg.lineWidth=.5,this._otherFrame.homeCoordGrid(this._minT,this._maxT,this._minX,this._maxX,this._step).forEach(_=>{t=this.toCanvasCoordsP(_[0]),this._ctxObg.beginPath(),this._ctxObg.moveTo(t.px,t.py),_.slice(1).forEach(v=>{e=this.toCanvasCoordsP(v),this._ctxObg.lineTo(e.px,e.py),t=e}),this._ctxObg.stroke()}),h=this._otherFrame.homeCoordAxes(this._minT,this._maxT,this._minX,this._maxX),this._ctxObg.strokeStyle="rgb(150,150,180)",this._ctxObg.lineWidth=1,t=this.toCanvasCoordsP(h[0][0]),e=this.toCanvasCoordsP(h[0][1]),this._ctxObg.beginPath(),this._ctxObg.moveTo(t.px,t.py),this._ctxObg.lineTo(e.px,e.py),this._ctxObg.stroke(),t=this.toCanvasCoordsP(h[1][0]),e=this.toCanvasCoordsP(h[1][1]),this._ctxObg.beginPath(),this._ctxObg.moveTo(t.px,t.py),this._ctxObg.lineTo(e.px,e.py),this._ctxObg.stroke()),this._ctxHbg.strokeStyle="rgb(80, 80, 80)",this._ctxHbg.lineWidth=1,this._ctxObg.strokeStyle="rgb(80, 80, 80)",this._ctxObg.lineWidth=1;const a=Math.ceil(this._minT/this._step)*this._step,u=Math.floor(this._maxT/this._step)*this._step;for(let r=a;r<=u;r=r+this._step)r!==0&&(t=this.toCanvasCoords(r,this._minX),e=this.toCanvasCoords(r,this._maxX),this._ctxHbg.beginPath(),this._ctxHbg.moveTo(t.px,t.py),this._ctxHbg.lineTo(e.px,e.py),this._ctxHbg.stroke(),this._ctxObg.beginPath(),this._ctxObg.moveTo(t.px,t.py),this._ctxObg.lineTo(e.px,e.py),this._ctxObg.stroke());const d=Math.ceil(this._minX/this._step)*this._step,c=Math.floor(this._maxX/this._step)*this._step;for(let r=d;r<=c;r=r+this._step)r!==0&&(t=this.toCanvasCoords(this._minT,r),e=this.toCanvasCoords(this._maxT,r),this._ctxHbg.beginPath(),this._ctxHbg.moveTo(t.px,t.py),this._ctxHbg.lineTo(e.px,e.py),this._ctxHbg.stroke(),this._ctxObg.beginPath(),this._ctxObg.moveTo(t.px,t.py),this._ctxObg.lineTo(e.px,e.py),this._ctxObg.stroke());this._ctxHbg.strokeStyle="black",this._ctxHbg.lineWidth=2,this._ctxObg.strokeStyle="black",this._ctxObg.lineWidth=2,t=this.toCanvasCoords(this._minT,0),e=this.toCanvasCoords(this._maxT,0),this._ctxHbg.beginPath(),this._ctxHbg.moveTo(t.px,t.py),this._ctxHbg.lineTo(e.px,e.py),this._ctxHbg.stroke(),this._ctxObg.beginPath(),this._ctxObg.moveTo(t.px,t.py),this._ctxObg.lineTo(e.px,e.py),this._ctxObg.stroke(),t=this.toCanvasCoords(0,this._minX),e=this.toCanvasCoords(0,this._maxX),this._ctxHbg.beginPath(),this._ctxHbg.moveTo(t.px,t.py),this._ctxHbg.lineTo(e.px,e.py),this._ctxHbg.stroke(),this._ctxObg.beginPath(),this._ctxObg.moveTo(t.px,t.py),this._ctxObg.lineTo(e.px,e.py),this._ctxObg.stroke();const l=this._width/10;this._ctxHbg.font=`italic ${l}px serif`,s&&(this._ctxHbg.fillStyle="rgb(180,180,210)",this._ctxHbg.textAlign="left",this._ctxHbg.textBaseline="top",t=this.toCanvasCoordsP(i[1][1]),this._ctxHbg.fillText("t′",t.px,t.py+this._width/72),this._ctxHbg.fillStyle="rgb(180,180,210)",this._ctxHbg.textAlign="right",this._ctxHbg.textBaseline="alphabetic",t=this.toCanvasCoordsP(i[0][1]),this._ctxHbg.fillText("x′",t.px-this._width/60,t.py)),this._ctxHbg.fillStyle="black",this._ctxHbg.textAlign="left",this._ctxHbg.textBaseline="top",t=this.toCanvasCoords(this._maxT,0),this._ctxHbg.fillText("t",t.px+this._width/72,t.py),this._ctxHbg.fillStyle="black",this._ctxHbg.textAlign="right",this._ctxHbg.textBaseline="alphabetic",t=this.toCanvasCoords(0,this._maxX),this._ctxHbg.fillText("x",t.px-this._width/60,t.py-this._width/72),this._ctxObg.font=`italic ${l}px serif`,s&&(this._ctxObg.fillStyle="rgb(180,180,210)",this._ctxObg.textAlign="left",this._ctxObg.textBaseline="top",t=this.toCanvasCoordsP(h[1][1]),this._ctxObg.fillText("t",t.px+this._width/30,t.py+this._width/72),this._ctxObg.textAlign="right",this._ctxObg.textBaseline="alphabetic",this._ctxObg.fillStyle="rgb(180,180,210)",t=this.toCanvasCoordsP(h[0][1]),this._ctxObg.fillText("x",t.px-this._width/60,t.py-this._width/45)),this._ctxObg.fillStyle="black",this._ctxObg.textAlign="left",this._ctxObg.textBaseline="top",t=this.toCanvasCoords(this._maxT,0),this._ctxObg.fillText("t′",t.px+this._width/72,t.py),this._ctxObg.fillStyle="black",this._ctxObg.textAlign="right",this._ctxObg.textBaseline="alphabetic",t=this.toCanvasCoords(0,this._maxX),this._ctxObg.fillText("x′",t.px-this._width/60,t.py-this._width/72)}drawTrajectory(t){t.getSegments().forEach(e=>{e&&this.drawSegment(e,t.color)}),t.getName()!==""&&(this._ctxH.textAlign="center",this._ctxH.textBaseline="middle",this._ctxO.textAlign="center",this._ctxO.textBaseline="middle"),t.getEvents().forEach(e=>{e.getVIn()!=="HELP"&&this.drawTrajEvent(e,t.color,t.getName())}),t.heartbeats(this._otherFrame,this._beatStep,this._minVisT,this._maxVisT).forEach(e=>{const s=Math.min(3,this._width/65),i=this.toCanvasCoords(e.t,e.x),h=this.toOtherCanvasCoords(e.t,e.x);this._ctxH.fillStyle=rt,this._ctxO.fillStyle=rt,this._ctxH.beginPath(),this._ctxO.beginPath(),this._ctxH.arc(i.px,i.py,s,0,2*Math.PI,!0),this._ctxO.arc(h.px,h.py,s,0,2*Math.PI,!0),this._ctxH.fill(),this._ctxO.fill()})}drawSegment(t,e="black"){const i=t.shape(this._minVisT,this._maxVisT);let h,a,u,d;this._ctxH.lineCap="round",this._ctxO.lineCap="round",t.type()==="lightlike"&&(this._ctxH.strokeStyle=e,this._ctxO.strokeStyle=e,this._ctxH.setLineDash([1,5]),this._ctxO.setLineDash([1,5])),t.type()==="spacelike"&&(this._ctxH.strokeStyle=e,this._ctxO.strokeStyle=e,this._ctxH.setLineDash([8,6]),this._ctxO.setLineDash([8,6])),t.type()==="backInTime"&&(this._ctxH.strokeStyle=e,this._ctxO.strokeStyle=e,this._ctxH.setLineDash([8,5,1,5]),this._ctxO.setLineDash([8,5,1,5])),this._ctxH.strokeStyle=e,this._ctxH.lineWidth=3,this._ctxO.strokeStyle=e,this._ctxO.lineWidth=3,h=this.toCanvasCoordsP(i[0]),u=this.toOtherCanvasCoordsP(i[0]),this._ctxH.beginPath(),this._ctxH.moveTo(h.px,h.py),this._ctxO.beginPath(),this._ctxO.moveTo(u.px,u.py),i.slice(1).forEach(c=>{a=this.toCanvasCoordsP(c),d=this.toOtherCanvasCoordsP(c),this._ctxH.lineTo(a.px,a.py),this._ctxO.lineTo(d.px,d.py),h=a,u=d}),this._ctxH.stroke(),this._ctxO.stroke(),this._ctxH.setLineDash([]),this._ctxO.setLineDash([])}drawTrajEvent(t,e="black",s=""){const i=this._width/60,h=t.getCoords(),a=this.toCanvasCoordsP(h),u=this.toOtherCanvasCoordsP(h);if(this._ctxH.fillStyle=e,this._ctxO.fillStyle=e,s!==""){const d=i*4;this._ctxH.font=`${d}px monospace`,this._ctxH.fillText(s,a.px,a.py),this._ctxO.font=`${d}px monospace`,this._ctxO.fillText(s,u.px,u.py)}else this._ctxH.beginPath(),this._ctxO.beginPath(),this._ctxH.arc(a.px,a.py,i,0,2*Math.PI,!0),this._ctxO.arc(u.px,u.py,i,0,2*Math.PI,!0),this._ctxH.fill(),this._ctxO.fill()}drawLoneEvent(t){const e=this._width/72,s=this.toCanvasCoords(t.t,t.x),i=this.toOtherCanvasCoords(t.t,t.x);if(this._ctxH.fillStyle=t.color,this._ctxO.fillStyle=t.color,t.symbol!==""&&(this._ctxH.textAlign="center",this._ctxH.textBaseline="middle",this._ctxO.textAlign="center",this._ctxO.textBaseline="middle"),t.symbol!==""){const h=e*4;this._ctxH.font=`${h}px monospace`,this._ctxH.fillText(t.symbol,s.px,s.py),this._ctxO.font=`${h}px monospace`,this._ctxO.fillText(t.symbol,i.px,i.py)}else this._ctxH.beginPath(),this._ctxO.beginPath(),this._ctxH.arc(s.px,s.py,e,0,2*Math.PI,!0),this._ctxO.arc(i.px,i.py,e,0,2*Math.PI,!0),this._ctxH.fill(),this._ctxO.fill()}clearAnims(){this._ctxHa.clearRect(0,0,this._width,this._animHeight),this._ctxOa.clearRect(0,0,this._width,this._animHeight),this._duplicateAnim&&this._ctxDHa.clearRect(0,0,this._width,this._animHeight)}replicateAnim(){this._duplicateAnim&&this._ctxDHa.drawImage(this._homeAnim,0,0)}drawAnimPoints(t,e,s="black",i="",h=!0){const a=this._width/45,u=this._width/60,d=i!=="";let c;d&&(this._ctxHa.lineWidth=2,this._ctxHa.textAlign="center",this._ctxHa.textBaseline="middle",this._ctxOa.lineWidth=2,this._ctxOa.textAlign="center",this._ctxOa.textBaseline="middle",c=a*3);const l=this._animHeight/2.5;t.forEach(r=>{if(this._ctxHa.fillStyle=s,this._ctxHa.strokeStyle=s,d?(this._ctxHa.font=`${c}px monospace`,r.type==="timelike"||r.type==="constA"||r.type==="lightlike"?this._ctxHa.fillText(i,this.toCanvasX(r.x),l+2):r.type!=="backInTime"?(this._ctxHa.fillText(i,this.toCanvasX(r.x),l+2),this._ctxHa.beginPath(),this._ctxHa.arc(this.toCanvasX(r.x),l,l-2,2*Math.PI,!1),this._ctxHa.stroke()):(this._ctxHa.filter&&(this._ctxHa.filter="invert()"),this._ctxHa.fillText(i,this.toCanvasX(r.x),this._animHeight/2+2),this._ctxHa.filter?this._ctxHa.filter="none":(this._ctxHa.globalCompositeOperation="difference",this._ctxHa.fillStyle="white",this._ctxHa.fillRect(this.toCanvasX(r.x)-c/2,l-c/2,c,c),this._ctxHa.globalCompositeOperation="source-over"),this._ctxHa.beginPath(),this._ctxHa.arc(this.toCanvasX(r.x),l,l-2,2*Math.PI,!1),this._ctxHa.stroke())):(this._ctxHa.beginPath(),r.type==="timelike"||r.type==="constA"?(this._ctxHa.arc(this.toCanvasX(r.x),l,a,2*Math.PI,!1),this._ctxHa.fill()):r.type==="spacelike"?(this._ctxHa.lineWidth=u,this._ctxHa.arc(this.toCanvasX(r.x),l,a-u/2,2*Math.PI,!1),this._ctxHa.stroke()):r.type==="backInTime"?(this._ctxHa.lineWidth=u*.667,this._ctxHa.arc(this.toCanvasX(r.x),l,a-u/4,2*Math.PI,!1),this._ctxHa.stroke()):r.type==="lightlike"?(this._ctxHa.arc(this.toCanvasX(r.x),l,a*.6667,2*Math.PI,!1),this._ctxHa.fill()):(this._ctxHa.arc(this.toCanvasX(r.x),l,a,2*Math.PI,!1),this._ctxHa.fill())),h){const m=(r.tau%this._beatStep+this._beatStep)%this._beatStep;if(m<Q){const _=1-m/Q;this.drawAnimHeartbeat(this._ctxHa,r.x,_,r.tau)}}}),e.forEach(r=>{if(this._ctxOa.fillStyle=s,this._ctxOa.strokeStyle=s,d?(this._ctxOa.font=`${c}px monospace`,r.type==="timelike"||r.type==="constA"||r.type==="lightlike"?this._ctxOa.fillText(i,this.toCanvasX(r.x),l+2):r.type!=="backInTime"?(this._ctxOa.fillText(i,this.toCanvasX(r.x),l+2),this._ctxOa.beginPath(),this._ctxOa.arc(this.toCanvasX(r.x),l,l-2,2*Math.PI,!1),this._ctxOa.stroke()):(this._ctxOa.filter&&(this._ctxOa.filter="invert()"),this._ctxOa.fillText(i,this.toCanvasX(r.x),l+2),this._ctxOa.filter?this._ctxOa.filter="none":(this._ctxOa.globalCompositeOperation="difference",this._ctxOa.fillStyle="white",this._ctxOa.fillRect(this.toCanvasX(r.x)-c/2,l-c/2,c,c),this._ctxOa.globalCompositeOperation="source-over"),this._ctxOa.beginPath(),this._ctxOa.arc(this.toCanvasX(r.x),l,l-2,2*Math.PI,!1),this._ctxOa.stroke())):(this._ctxOa.beginPath(),r.type==="timelike"||r.type==="constA"?(this._ctxOa.arc(this.toCanvasX(r.x),l,a,2*Math.PI,!1),this._ctxOa.fill()):r.type==="spacelike"?(this._ctxOa.lineWidth=u,this._ctxOa.arc(this.toCanvasX(r.x),l,a-u/2,2*Math.PI,!1),this._ctxOa.stroke()):r.type==="backInTime"?(this._ctxOa.lineWidth=u*.667,this._ctxOa.arc(this.toCanvasX(r.x),l,a-u/4,2*Math.PI,!1),this._ctxOa.stroke()):r.type==="lightlike"?(this._ctxOa.arc(this.toCanvasX(r.x),l,a*.6667,2*Math.PI,!1),this._ctxOa.fill()):(this._ctxOa.arc(this.toCanvasX(r.x),l,a,2*Math.PI,!1),this._ctxOa.fill())),h){const m=(r.tau%this._beatStep+this._beatStep)%this._beatStep;if(m<Q){const _=1-m/Q;this.drawAnimHeartbeat(this._ctxOa,r.x,_,r.tau)}}})}drawHomeAnimLoneEvent(t,e=1){const s=this._width/45,i=t.symbol!=="";this._ctxHa.fillStyle=t.color,this._ctxHa.globalAlpha=e;const h=this._animHeight/2;let a;i?(this._ctxHa.textAlign="center",this._ctxHa.textBaseline="middle",a=s*3,this._ctxHa.font=`${a}px monospace`,this._ctxHa.fillText(t.symbol,this.toCanvasX(t.x),h+2)):(this._ctxHa.beginPath(),this._ctxHa.arc(this.toCanvasX(t.x),h,s,2*Math.PI,!1),this._ctxHa.fill()),this._ctxHa.globalAlpha=1}drawOtherAnimLoneEvent(t,e,s,i=1){const h=this._width/45,a=e!=="";this._ctxOa.fillStyle=s,this._ctxOa.globalAlpha=i;const u=this._animHeight/2;if(a){this._ctxOa.textAlign="center",this._ctxOa.textBaseline="middle";const d=h*3;this._ctxOa.font=`${d}px monospace`,this._ctxOa.fillText(e,this.toCanvasX(t),u+2)}else this._ctxOa.beginPath(),this._ctxOa.arc(this.toCanvasX(t),u,h,2*Math.PI,!1),this._ctxOa.fill();this._ctxOa.globalAlpha=1}drawAnimHeartbeat(t,e,s=1,i=null){const h=this._width/72;let a;Number.isFinite(i)?a=Math.floor(i/this._beatStep)*this._beatStep:a="❤️",t.fillStyle=rt,t.globalAlpha=s,t.textAlign="center",t.textBaseline="middle";const u=h*2.5;t.font=`${u}px monospace`;const d=this._animHeight-(this._animHeight*.85-this._width/15)/2;t.fillText(a,this.toCanvasX(e),d),t.globalAlpha=1}highlightEvent(t){const s=this.toCanvasCoords(t.t,t.x),i=this.toOtherCanvasCoords(t.t,t.x);this._ctxH.strokeStyle="#F0E442",this._ctxH.lineWidth=4,this._ctxO.strokeStyle="#F0E442",this._ctxO.lineWidth=4,this._ctxH.beginPath(),this._ctxO.beginPath(),this._ctxH.arc(s.px,s.py,16,0,2*Math.PI,!0),this._ctxO.arc(i.px,i.py,16,0,2*Math.PI,!0),this._ctxH.stroke(),this._ctxO.stroke()}}class wt{constructor(t){this._beta=0,this._gamma=1,this.setBeta(t)}getBeta(){return this._beta}setBeta(t){Number.isFinite(t)&&(t<=-1||t>=1)&&($(`Velocity ${t} is not -1 < v < 1`,": setting to 0."),t=0),this._beta=Number(t),this._gamma=Math.pow(1-this._beta**2,-.5)}otherT(t,e){return this._gamma*(t-this._beta*e)}otherX(t,e){return this._gamma*(-this._beta*t+e)}otherV(t){return(t<=-1||t>=1)&&($(`Velocity ${t} is not -1 < v < 1`,": setting to 0."),t=0),(t-this._beta)/(1-t*this._beta)}homeT(t,e){return this._gamma*(t+this._beta*e)}homeX(t,e){return this._gamma*(this._beta*t+e)}homeV(t){return(t<=-1||t>=1)&&($(`Velocity ${t} is not -1 < v < 1`,": setting to 0."),t=0),(t+this._beta)/(1+t*this._beta)}otherCoordAxes(t,e,s,i,h=this._beta){const a=[];return a.push([{t:h*s,x:s},{t:h*i,x:i}]),a.push([{t,x:h*t},{t:e,x:h*e}]),a}homeCoordAxes(t,e,s,i){return this.otherCoordAxes(t,e,s,i,-this._beta)}otherCoordGrid(t,e,s,i,h,a=1){const u=[];let d,c,l,r;a===-1?(d=Math.min(this.homeT(t,s),this.homeT(t,i)),c=Math.min(this.homeX(t,s),this.homeX(e,s)),l=Math.max(this.homeT(e,s),this.homeT(e,i)),r=Math.max(this.homeX(t,i),this.homeX(e,i))):(d=Math.min(this.otherT(t,s),this.otherT(t,i)),c=Math.min(this.otherX(t,s),this.otherX(e,s)),l=Math.max(this.otherT(e,s),this.otherT(e,i)),r=Math.max(this.otherX(t,i),this.otherX(e,i)));const m=Math.ceil(d/h+.01)*h,_=Math.floor(l/h-.01)*h,v=Math.ceil(c/h+.01)*h,V=Math.floor(r/h-.01)*h;for(let x=m;x<=_;x=x+h)u.push([{t:x/this._gamma+a*this._beta*s,x:s},{t:x/this._gamma+a*this._beta*i,x:i}]);for(let x=v;x<=V;x=x+h)u.push([{t,x:x/this._gamma+a*this._beta*t},{t:e,x:x/this._gamma+a*this._beta*e}]);return u}homeCoordGrid(t,e,s,i,h){return this.otherCoordGrid(t,e,s,i,h,-1)}}function j(n){return!(n==="SAME"||Number.isFinite(n))}class X{constructor(t,e,s="AUTO",i="AUTO"){this._t=t,this._x=e,this._vIn="AUTO",this._vOut="AUTO",s!=="AUTO"&&this.setVIn(s),i!=="AUTO"&&this.setVOut(i),this.num=null}getCoords(){return{t:this._t,x:this._x}}getT(){return this._t}getX(){return this._x}setCoords(t,e){this._t=t,this._x=e}_setVelocity(t,e){if(t!=="_vIn"&&t!=="_vOut")throw new RangeError(`Trying to set invalid velocity variable ${t}!`);if(e==="SAME"||e==="AUTO"||e==="HELP"){this[t]=e;return}if(e>-1&&e<1){this[t]=e;return}if(e<=-1||e>=1){$(`Velocity ${t} = ${e} is not in range -1 < v < 1`,": treating as AUTO."),this[t]="AUTO";return}$(`Velocity ${e} invalid: must be in range -1 < v < 1 (or AUTO or SAME)`,": treating as AUTO."),this[t]="AUTO"}setVIn(t){this._setVelocity("_vIn",t)}setVOut(t){this._setVelocity("_vOut",t)}getVIn(){return this._vIn}getVOut(){return this._vOut}serialize(){const t=[];return this._vOut!=="AUTO"?(Number.isFinite(this._vOut)?t.unshift(Math.round(this._vOut*1e4)/1e4):t.unshift("S"),Number.isFinite(this._vIn)?t.unshift(Math.round(this._vIn*1e4)/1e4):this._vIn==="AUTO"?t.unshift("A"):t.unshift("S")):this._vIn!=="AUTO"&&(Number.isFinite(this._vIn)?t.unshift(Math.round(this._vIn*1e4)/1e4):t.unshift("S")),t.unshift(Math.round(this._x*1e4)/1e4),t.unshift(Math.round(this._t*1e4)/1e4),t}static fromSerialized(t){return t.length>2&&(t[2]==="A"?t[2]="AUTO":t[2]==="S"&&(t[2]="SAME")),t.length>3&&t[3]==="S"&&(t[3]="SAME"),new X(...t)}}function B(n,t,e,s,i=!1){const h=Math.min(e,s),a=Math.max(e,s);let u;return Number.isFinite(a-h)?u=(a-h)*.001:u=1e-10,t<h-u||t>a+u?i?!1:($(`${n} ${t} is outside ${h} -- ${a}`,"default to start."),e):t<h?h:t>a?a:t}class ct{constructor(t,e,s=!1,i=!1){this._start=t,this._end=e,this._extrapI=s,this._extrapF=i,this._ti=0,this._xi=0,this._tf=0,this._xf=0,this._dt=0,this._dx=0,this._segType="undefined",this._dtau=0,this._minTau=0,this._maxTau=0,this.num=null}_getEventCoords(){this._ti=this._start.getT(),this._xi=this._start.getX(),this._tf=this._end.getT(),this._xf=this._end.getX(),this._dt=this._tf-this._ti,this._dx=this._xf-this._xi}updateCoords(){throw new Error("updateCoords() must be implemented by a subclass")}setExtrapI(t){this._extrapI=t,this._extrapI!==!0?this._minTau=0:this._minTau=Number.NEGATIVE_INFINITY}setExtrapF(t){this._extrapF=t,this._extrapF!==!0?this._maxTau=this._dtau:this._maxTau=Number.POSITIVE_INFINITY}getExtrapI(){return this._extrapI}getExtrapF(){return this._extrapF}getTInitial(){return this._ti}getTFinal(){return this._tf}includesT(t){let e,s;return this._extrapI!==!0||this._ti===this._tf?e=this._ti:this._ti<this._tf?e=Number.NEGATIVE_INFINITY:e=Number.POSITIVE_INFINITY,this._extrapF!==!0||this._ti===this._tf?s=this._tf:this._ti<this._tf?s=Number.POSITIVE_INFINITY:s=Number.NEGATIVE_INFINITY,t>=Math.min(e,s)&&t<=Math.max(e,s)}includesOtherT(t,e){const s=e.otherT(this._ti,this._xi),i=e.otherT(this._tf,this._xf);let h,a;return this._extrapI!==!0||s===i?h=s:s<i?h=Number.NEGATIVE_INFINITY:h=Number.POSITIVE_INFINITY,this._extrapF!==!0||s===i?a=i:s<i?a=Number.POSITIVE_INFINITY:a=Number.NEGATIVE_INFINITY,t>=Math.min(h,a)&&t<=Math.max(h,a)}tauAtFrac(t){return t=B("Fraction",t,0,1),this._dtau*t}tauOfT(t){let e,s;return this._extrapI!==!0||this._ti===this._tf?e=this._ti:this._ti<this._tf?e=Number.NEGATIVE_INFINITY:e=Number.POSITIVE_INFINITY,this._extrapF!==!0||this._ti===this._tf?s=this._tf:this._ti<this._tf?s=Number.POSITIVE_INFINITY:s=Number.NEGATIVE_INFINITY,t=B("Time",t,e,s,!0),t===!1?!1:this._tauOfTInternal(t)}tauOfTOther(t,e){const s=e.otherT(this._ti,this._xi),i=e.otherT(this._tf,this._xf);let h,a;return this._extrapI!==!0||s===i?h=s:s<i?h=Number.NEGATIVE_INFINITY:h=Number.POSITIVE_INFINITY,this._extrapF!==!0||s===i?a=i:s<i?a=Number.POSITIVE_INFINITY:h=Number.NEGATIVE_INFINITY,t=B("Time",t,h,a,!0),t===!1?!1:this._tauOfTOtherInternal(t,e,s,i)}xOfT(t){let e,s;return this._extrapI!==!0||this._ti===this._tf?e=this._ti:this._ti<this._tf?e=Number.NEGATIVE_INFINITY:e=Number.POSITIVE_INFINITY,this._extrapF!==!0||this._ti===this._tf?s=this._tf:this._ti<this._tf?s=Number.POSITIVE_INFINITY:e=Number.NEGATIVE_INFINITY,t=B("Time",t,e,s,!0),t===!1?!1:this._xOfTInternal(t)}xOfTOther(t,e){const s=e.otherT(this._ti,this._xi),i=e.otherT(this._tf,this._xf);let h,a;return this._extrapI!==!0||s===i?h=s:s<i?h=Number.NEGATIVE_INFINITY:h=Number.POSITIVE_INFINITY,this._extrapF!==!0||s===i?a=i:s<i?a=Number.POSITIVE_INFINITY:a=Number.NEGATIVE_INFINITY,t=B("Time",t,h,a,!0),t===!1?!1:this._xOfTOtherInternal(t,e,s,i)}xOfTau(t){return t=B("Proper time",t,this._minTau,this._maxTau),this._xOfTauInternal(t)}tOfTau(t){return t=B("Proper time",t,this._minTau,this._maxTau),this._tOfTauInternal(t)}vOfT(t){return t=B("Time",t,this._ti,this._tf),this._vOfTInternal(t)}vOfTau(t){return t=B("Proper time",t,this._minTau,this._maxTau),this._vOfTauInternal(t)}vOtherOfTau(t,e){return t=B("Proper time",t,this._minTau,this._maxTau),this._vOtherOfTauInternal(t,e)}getVInitial(){return this.vOfTau(0)}getVFinal(){return this.vOfTau(this._dtau)}getOtherVInitial(t){return this.vOtherOfTau(0,t)}getOtherVFinal(t){return this.vOtherOfTau(this._dtau,t)}getAccel(){return this._getAccelInternal()}shape(){throw new Error("This function must be implemented by the subclass!")}type(){return this._segType}}const Ot=1;class J extends ct{constructor(t,e){super(t,e),this._segType="timelike",this._v=0,this.updateCoords()}updateCoords(){this._getEventCoords(),this._dt===0&&this._dx===0?this._segType="timelike":this._dt<=-Math.abs(this._dx)?this._segType="backInTime":this._dt===Math.abs(this._dx)?this._segType="lightlike":this._dt<Math.abs(this._dx)?this._segType="spacelike":this._segType="timelike",this._dx===0?this._v=0:this._dt!==0?this._v=this._dx/this._dt:this._dx>0?this._v=Number.POSITIVE_INFINITY:this._v=Number.NEGATIVE_INFINITY,this._segType==="timelike"?this._dtau=Math.sqrt(this._dt**2-this._dx**2):this._dtau=Ot,this._extrapI!==!0?this._minTau=0:this._minTau=Number.NEGATIVE_INFINITY,this._extrapF!==!0?this._maxTau=this._dtau:this._maxTau=Number.POSITIVE_INFINITY}_tauOfTInternal(t){return this._dt===0?0:this._dtau*(t-this._ti)/this._dt}_tauOfTOtherInternal(t,e,s,i){return this._dt===0?0:this._dtau*(t-s)/(i-s)}_xOfTInternal(t){return this._dt===0?this._xi:this._xi+this._dx*((t-this._ti)/this._dt)}_xOfTOtherInternal(t,e,s,i){if(this._dt===0)return this._xi;const h=e.otherX(this._ti,this._xi),a=e.otherX(this._tf,this._xf);return h+(a-h)*((t-s)/(i-s))}_xOfTauInternal(t){return this._dtau===0?this._xi:this._xi+this._dx*(t/this._dtau)}_tOfTauInternal(t){return this._dtau===0?this._ti:this._ti+this._dt*(t/this._dtau)}_vOfTInternal(){return this._v}_vOfTauInternal(){return this._v}_vOtherOfTauInternal(t,e){if(Number.isFinite(this._v)){const s=e.otherT(this._dt,this._dx);return e.otherX(this._dt,this._dx)/s}else return this._v}_getAccelInternal(){return 0}shape(t,e){let s,i,h,a;return this._extrapI!==!0||this._dt===0?(s=this._ti,h=this._xi):this._ti<this._tf?(s=t,h=this._xOfTInternal(t)):(s=e,h=this._xOfTInternal(e)),this._extrapF!==!0||this._dt===0?(i=this._tf,a=this._xf):this._ti<this._tf?(i=e,a=this._xOfTInternal(e)):(i=t,a=this._xOfTInternal(t)),[{t:s,x:h},{t:i,x:a}]}}const ht=1e-5;function q(n,t,e,s){const i=n.getT()-t.getT(),h=n.getX()-t.getX();let a;if(e==="AUTO"&&Number.isFinite(s))a=s;else if(Number.isFinite(e)&&s==="AUTO")a=e;else return K(`Wrong velocities (${e} and ${s}) for segment construction`,": treating as AUTO."),new J(n,t);return Math.abs(a-h/i)<ht?new J(n,t):new Et(n,t,e,s)}class Et extends ct{constructor(t,e,s,i){super(t,e),this._segType="constA",this._vi=0,this._vf=0,this._wi=0,this._wf=0,this._accel=0,this._accelT0=0,this._accelX0=0,this.updateCoords(s,i)}updateCoords(t,e){if(this._getEventCoords(),this._dt<=Math.abs(this._dx))throw new RangeError(`Segment isn't timelike (dt:${this._dt}, dx:${this._dx}): not valid for const accel.`);if(!(t==="AUTO"&&Number.isFinite(e)&&e>-1&&e<1||Number.isFinite(t)&&e==="AUTO"&&t>-1&&t<1))throw new RangeError(`Velocities not compatible with const accel (vi:${t}, vf:${e}).`);if(t===this._dx/this._dt||e===this._dx/this._dt)throw new RangeError(`Segment has const v (dt:${this._dt}, dx:${this._dx}, v1:${t}, v2:${e}): not valid for const accel.`);e==="AUTO"?(this._vi=t,this._wi=Math.atanh(this._vi),this._wf=2*Math.atanh(this._dx/this._dt)-this._wi,this._vf=Math.tanh(this._wf)):(this._vf=e,this._wf=Math.atanh(this._vf),this._wi=2*Math.atanh(this._dx/this._dt)-this._wf,this._vi=Math.tanh(this._wi)),this._accel=(Math.sinh(this._wf)-Math.sinh(this._wi))/this._dt,this._accelT0=this._ti-Math.sinh(this._wi)/this._accel,this._accelX0=this._xi-Math.cosh(this._wi)/this._accel,this._dtau=(this._wf-this._wi)/this._accel,this._extrapI!==!0?this._minTau=0:this._minTau=Number.NEGATIVE_INFINITY,this._extrapF!==!0?this._maxTau=this._dtau:this._maxTau=Number.POSITIVE_INFINITY}_tauOfTInternal(t){return(Math.asinh(this._accel*(t-this._accelT0))-this._wi)/this._accel}_tauOfTOtherInternal(t,e){const s=e.otherT(this._accelT0,this._accelX0);return(Math.asinh(this._accel*(t-s))-this._wi+Math.atanh(e.getBeta()))/this._accel}_xOfTInternal(t){return Math.cosh(this._accel*this.tauOfT(t)+this._wi)/this._accel+this._accelX0}_xOfTOtherInternal(t,e){const s=e.otherT(this._accelT0,this._accelX0),i=e.otherX(this._accelT0,this._accelX0),h=Math.asinh(this._accel*(t-s));return Math.cosh(h)/this._accel+i}_xOfTauInternal(t){return Math.cosh(this._accel*t+this._wi)/this._accel+this._accelX0}_tOfTauInternal(t){return Math.sinh(this._accel*t+this._wi)/this._accel+this._accelT0}_vOfTInternal(t){return Math.tanh(this.tauOfT(t)*this._accel+this._wi)}_vOfTauInternal(t){return Math.tanh(t*this._accel+this._wi)}_vOtherOfTauInternal(t,e){return e.otherV(Math.tanh(t*this._accel+this._wi))}_getAccelInternal(){return this._accel}shape(t,e){let s,i;this._extrapI!==!0?s=0:s=this._tauOfTInternal(t),this._extrapF!==!0?i=this._dtau:i=this._tauOfTInternal(e);const h=[],a=.02/Math.abs(this._accel);for(let u=s;u<i;u+=a)h.push({t:this._tOfTauInternal(u),x:this._xOfTauInternal(u)});return h.push({t:this._tOfTauInternal(i),x:this._xOfTauInternal(i)}),i<this._dtau&&h.push({t:this._tOfTauInternal(this._dtau),x:this._xOfTauInternal(this._dtau)}),h}originT(){return this._accelT0}originX(){return this._accelX0}}function It(n){const t=atob(n);return Uint8Array.from(t,e=>e.codePointAt(0))}function Xt(n){return new TextDecoder().decode(It(n))}function At(n){const t=Array.from(n,e=>String.fromCodePoint(e)).join("");return btoa(t)}function Nt(n){return At(new TextEncoder().encode(n))}const Ct=6,S=[{color:"#E69F00",name:"Orange"},{color:"#56B4E9",name:"Sky"},{color:"#009E73",name:"Green"},{color:"#0072B2",name:"Blue"},{color:"#CC79A7",name:"Pink"}];function T(n,t,e=1e5){return Math.round(n*e/t.getDiagram().getStep())*t.getDiagram().getStep()/e}function O(n,t,...e){return function(s){const i=window.scrollY;n(...e,s),t.update(),ut(t),requestAnimationFrame(()=>{window.scrollTo(0,i)})}}function Bt(n){const t=document.styleSheets[0];for(let o=0;o<S.length;o++)t.insertRule(`.color-${o} { color: ${S[o].color}; }`,t.cssRules.length);const e=n.getDiagram().getCoordRange(),s=document.getElementById("FrameBeta");n.setOtherVel(s.valueAsNumber);function i(o){n.setOtherVel(o.target.valueAsNumber)}s.addEventListener("change",i);const h=document.getElementById("TimesliceValue");h.min=e.minT,h.max=e.maxT,h.step=e.step/10;function a(o){n.setTimeslice(Number(o.target.value))}h.addEventListener("change",a),n.setTimeslice(Number(h.value));const u=document.getElementById("HeartbeatStepVal");u.valueAsNumber=n.getDiagram().getHeartbeatStep(),u.addEventListener("change",o=>{o.target.valueAsNumber<=0?o.target.valueAsNumber=n.getDiagram().getHeartbeatStep():n.setHeartbeatStep(o.target.valueAsNumber)}),document.getElementById("CheckboxShowOther").addEventListener("change",o=>{o.target.checked?n.getDiagram().setOtherHidden(!1):n.getDiagram().setOtherHidden(!0)});const c=document.getElementById("timeUnitInput");c.addEventListener("change",()=>{n.setUnits(c.value)});const l=document.getElementById("coordRangeControls"),r=document.getElementById("tMinInput"),m=document.getElementById("tMaxInput"),_=document.getElementById("tStepInput"),v=document.getElementById("xMinInput");l.addEventListener("change",()=>{n.getDiagram().setCoordRange(r.valueAsNumber,m.valueAsNumber,_.valueAsNumber,v.valueAsNumber),n.record()});const V=document.getElementById("AnimStartPause");function x(o){o.target.value==="Start"?(o.target.value="Pause",o.target.textContent="Pause Animation",n.startMotion()):(o.target.value="Start",o.target.textContent="Start Animation",n.pauseMotion())}V.addEventListener("click",x);const I=document.getElementById("AnimCancel");function H(){V.value="Start",V.textContent="Start Animation",h.value="",n.cancelMotion()}I.addEventListener("click",H),document.getElementById("UndoButton").addEventListener("click",()=>{n.undo()}),document.getElementById("RedoButton").addEventListener("click",()=>{n.redo()});const N=document.getElementById("presetSelect");N.addEventListener("change",()=>{N.value!==""&&n.importState(JSON.parse(N.value))});const M=document.getElementById("StateURL"),b=document.getElementById("CopyURL");location.protocol==="https:"||location.hostname==="localhost"?b.addEventListener("click",()=>{navigator.clipboard.writeText(M.value).then(()=>{b.textContent="Copied!",setTimeout(()=>b.textContent="Copy URL",1500)}).catch(o=>{console.error("Failed to copy state: ",o)})}):(b.disabled=!0,b.textContent="(Copy manually)"),document.getElementById("AddLoneEvent").addEventListener("click",()=>{n.addLoneEvent(0,0)}),document.getElementById("AddTrajectory").addEventListener("click",()=>{n.addTrajectory()});const D=n.getDiagram().getHomeCanvas(),E=n.getDiagram().getOtherCanvas();D.addEventListener("mousedown",o=>it(o,n)),D.addEventListener("touchstart",o=>it(o,n),{passive:!1}),E.addEventListener("mousedown",o=>it(o,n)),E.addEventListener("touchstart",o=>it(o,n),{passive:!1}),D.addEventListener("mousemove",o=>st(o,n)),D.addEventListener("touchmove",o=>st(o,n),{passive:!1}),E.addEventListener("mousemove",o=>st(o,n)),E.addEventListener("touchmove",o=>st(o,n),{passive:!1}),D.addEventListener("mouseup",o=>W(o,n)),E.addEventListener("mouseup",o=>W(o,n)),D.addEventListener("mouseleave",o=>W(o,n)),E.addEventListener("mouseleave",o=>W(o,n)),D.addEventListener("touchend",o=>W(o,n)),E.addEventListener("touchend",o=>W(o,n)),D.addEventListener("touchcancel",o=>W(o,n)),E.addEventListener("touchcancel",o=>W(o,n));const Z=document.getElementById("selectedEventControls"),k=document.getElementById("selectedT"),Y=document.getElementById("selectedX"),P=document.getElementById("selectedTO"),p=document.getElementById("selectedXO"),U=document.getElementById("selectedVIn"),R=document.getElementById("selectedVInO"),z=document.getElementById("selectedVOut"),y=document.getElementById("selectedVOutO"),vt=document.getElementById("selected-vIn-auto"),pt=document.getElementById("selected-vOut-auto"),Tt=document.getElementById("selected-properTimeZero"),bt=document.getElementById("selected-removeEvent");k.addEventListener("change",O(()=>{const o=n.getSelected();if(!Number.isFinite(o.tNum))n.getLoneEvents()[o.eNum].t=k.valueAsNumber;else{const f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum);f.setEventCoords(g,k.valueAsNumber,Y.valueAsNumber)}},n)),Y.addEventListener("change",O(()=>{const o=n.getSelected();if(!Number.isFinite(o.tNum))n.getLoneEvents()[o.eNum].x=Y.valueAsNumber;else{const f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum);f.setEventCoords(g,k.valueAsNumber,Y.valueAsNumber)}},n)),P.addEventListener("change",O(()=>{const o=n.getDiagram().getOtherFrame().homeT(P.valueAsNumber,p.valueAsNumber),f=n.getDiagram().getOtherFrame().homeX(P.valueAsNumber,p.valueAsNumber),g=n.getSelected();if(!Number.isFinite(g.tNum))n.getLoneEvents()[g.eNum].t=o,n.getLoneEvents()[g.eNum].x=f;else{const A=n.getTrajectories()[g.tNum],C=A.getUserEventNum(g.eNum);A.setEventCoords(C,o,f)}},n)),p.addEventListener("change",O(()=>{const o=n.getDiagram().getOtherFrame().homeT(P.valueAsNumber,p.valueAsNumber),f=n.getDiagram().getOtherFrame().homeX(P.valueAsNumber,p.valueAsNumber),g=n.getSelected();if(!Number.isFinite(g.tNum))n.getLoneEvents()[g.eNum].t=o,n.getLoneEvents()[g.eNum].x=f;else{const A=n.getTrajectories()[g.tNum],C=A.getUserEventNum(g.eNum);A.setEventCoords(C,o,f)}},n)),U.addEventListener("change",O(()=>{const o=n.getSelected(),f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum),A=f.getEvents()[g],C=U.valueAsNumber;if(C<=-1||C>=1){U.valueAsNumber=T(A.getVIn(),n);return}f.setEventVIn(g,C)},n)),R.addEventListener("change",O(()=>{const o=n.getSelected(),f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum),A=f.getEvents()[g],C=R.valueAsNumber;if(C<=-1||C>=1){R.valueAsNumber=T(n.getDiagram().getOtherFrame().otherV(A.getVIn()),n);return}f.setEventVIn(g,n.getDiagram().getOtherFrame().homeV(C))},n)),z.addEventListener("change",O(()=>{const o=n.getSelected(),f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum),A=f.getEvents()[g],C=z.valueAsNumber;if(C<=-1||C>=1){z.valueAsNumber=T(A.getVOut(),n);return}f.setEventVOut(g,C)},n)),y.addEventListener("change",O(()=>{const o=n.getSelected(),f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum),A=f.getEvents()[g],C=y.valueAsNumber;if(C<=-1||C>=1){y.valueAsNumber=T(n.getDiagram().getOtherFrame().otherV(A.getVOut()),n);return}f.setEventVOut(g,n.getDiagram().getOtherFrame().homeV(C))},n)),Z.addEventListener("change",O(o=>{const f=n.getSelected(),g=n.getTrajectories()[f.tNum],A=g.getUserEventNum(f.eNum);if(o.target.classList.contains("vInMode"))switch(o.target.value){case"FIXED":g.setEventVIn(A,U.valueAsNumber);break;case"AUTO":g.setEventVIn(A,"AUTO");break;case"SAME":g.setEventVIn(A,"SAME");break;default:K("Invalid velocity (in) mode",": default to AUTO."),vt.checked=!0,g.setEventVIn(A,"AUTO")}else if(o.target.classList.contains("vOutMode"))switch(o.target.value){case"FIXED":g.setEventVOut(A,z.valueAsNumber);break;case"AUTO":g.setEventVOut(A,"AUTO");break;case"SAME":g.setEventVOut(A,"SAME");break;default:K("Invalid velocity (out) mode",": default to AUTO."),pt.checked=!0,g.setEventVOut(A,"AUTO")}},n)),Tt.addEventListener("click",O(()=>{const o=n.getSelected(),f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum);f.setZeroTau(g)},n)),bt.addEventListener("click",O(()=>{const o=n.getSelected();if(n.setSelected(null),!Number.isFinite(o.tNum))n.removeLoneEvent(o.eNum);else{const f=n.getTrajectories()[o.tNum],g=f.getUserEventNum(o.eNum);f.getEvents().length===1?n.removeTrajectory(o.tNum):f.removeEvent(g)}},n)),window.addEventListener("resize",()=>{n.getDiagram().setCanvasSizes(),n.redraw()}),dt(n),_t(n),lt(n)}function lt(n){const t=JSON.stringify(n.exportState()),e=Nt(t),s=new URL(location.origin+location.pathname);s.searchParams.set("data",e);const i=document.getElementById("StateURL");i&&(i.value=s)}function St(n){document.getElementById("FrameBeta").valueAsNumber=T(n.getDiagram().getOtherFrame().getBeta(),n),document.getElementById("HeartbeatStepVal").valueAsNumber=n.getDiagram().getHeartbeatStep();const t=n.getDiagram().getCoordRange();document.getElementById("tMinInput").valueAsNumber=t.minT,document.getElementById("tMaxInput").valueAsNumber=t.maxT,document.getElementById("tStepInput").valueAsNumber=t.step,t.minXAuto?document.getElementById("xMinInput").value="":document.getElementById("xMinInput").valueAsNumber=t.minX,n.getDiagram().getOtherHidden()?document.getElementById("CheckboxShowOther").checked=!1:document.getElementById("CheckboxShowOther").checked=!0,lt(n)}function dt(n){const t=document.getElementById("loneEventControls");t.innerHTML="";for(let e=0;e<n.getLoneEvents().length;e++)t.appendChild(Vt(n,n.getLoneEvents()[e]))}function _t(n){const t=document.getElementById("trajectoryControls");t.innerHTML="";for(let e=0;e<n.getTrajectories().length;e++)t.appendChild(Ht(n,n.getTrajectories()[e]))}function Vt(n,t){const e=document.createElement("div");e.classList.add("loneEventControlBlock");const s=document.createElement("label");s.classList.add("timeValue"),s.innerHTML="<i>t</i> = ";const i=document.createElement("input");i.classList.add("coordInput"),i.type="number",i.step="any",i.value=t.t,s.append(i),e.append(s);const h=document.createElement("label");h.classList.add("posValue"),h.innerHTML="<i>x</i> = ";const a=document.createElement("input");a.classList.add("coordInput"),a.type="number",a.step="any",a.value=t.x,h.append(a),e.append(h);const u=document.createElement("label"),d=document.createElement("span");d.append("Event color: "),d.classList.add("visually-hidden"),u.append(d);const c=mt();c.value=t.color,u.appendChild(c),e.appendChild(u);const l=document.createElement("label");l.classList.add("timeValue"),l.innerHTML="<i>t</i>′ = ";const r=document.createElement("input");r.classList.add("coordInput"),r.type="number",r.step="any",r.value=n.getDiagram().getOtherFrame().otherT(t.t,t.x),l.append(r),e.append(l);const m=document.createElement("label");m.classList.add("posValue"),m.innerHTML="<i>x</i>′ = ";const _=document.createElement("input");_.classList.add("coordInput"),_.type="number",_.step="any",_.value=n.getDiagram().getOtherFrame().otherX(t.t,t.x),m.append(_),e.append(m);const v=document.createElement("label");v.append("Symbol: ");const V=gt("eventIcons");V.value=t.symbol,v.appendChild(V),e.appendChild(v);const x=xt(()=>{n.removeLoneEvent(t.num)});return x.classList.add("eventCloseButton"),e.append(x),i.addEventListener("change",I=>{t.t=parseFloat(I.target.value),r.value=n.getDiagram().getOtherFrame().otherT(t.t,t.x),_.value=n.getDiagram().getOtherFrame().otherX(t.t,t.x),n.record()}),a.addEventListener("change",I=>{t.x=parseFloat(I.target.value),r.value=n.getDiagram().getOtherFrame().otherT(t.t,t.x),_.value=n.getDiagram().getOtherFrame().otherX(t.t,t.x),n.record()}),r.addEventListener("change",()=>{t.t=n.getDiagram().getOtherFrame().homeT(r.valueAsNumber,_.valueAsNumber),t.x=n.getDiagram().getOtherFrame().homeX(r.valueAsNumber,_.valueAsNumber),i.value=t.t,a.value=t.x,n.record()}),_.addEventListener("change",()=>{t.t=n.getDiagram().getOtherFrame().homeT(r.valueAsNumber,_.valueAsNumber),t.x=n.getDiagram().getOtherFrame().homeX(r.valueAsNumber,_.valueAsNumber),i.value=t.t,a.value=t.x,n.record()}),c.addEventListener("change",I=>{t.color=I.target.value,n.record()}),V.addEventListener("change",I=>{t.symbol=I.target.value,n.record()}),e}function Ht(n,t){const e=document.createElement("div");e.classList.add("trajectoryControlBlock");const s=document.createElement("label"),i=document.createElement("span");i.append("Trajectory color: "),i.classList.add("visually-hidden"),s.append(i);const h=mt();h.value=t.color,s.appendChild(h),e.appendChild(s);const a=document.createElement("label");a.append("Symbol: ");const u=gt("trajectoryIcons");u.value=t.getName(),a.appendChild(u),e.appendChild(a);const d=document.createElement("label");d.append("Show heartbeat");const c=document.createElement("input");c.type="checkbox",t.showHeartbeats?c.checked=!0:c.checked=!1,d.appendChild(c),e.appendChild(d);for(let m=0;m<t.getEvents().length;m++){let _;if(t.getSegments()[m]?_=tt(n,t,t.getSegments()[m],m):_=tt(n,t,null,m),e.appendChild(_),m===0){const v=ot(O(()=>{const V=(n.getMinT()+t.getEvents()[m].getT())/2,x=new X(V,t.getEvents()[m].getX());t.addEventAtStart(x);const I=n.getSelected();I&&t.num===I.tNum&&(I.eNum++,n.setSelected(I))},n));_.prepend(v)}e.appendChild(Lt(n,t,t.getEvents()[m],m))}let l;t.getSegments()[t.getEvents().length]?l=tt(n,t,t.getSegments()[t.getEvents().length],t.getEvents().length):l=tt(n,t,null,t.getEvents().length);const r=ot(O(()=>{const m=(n.getMaxT()+t.getEvents()[t.getEvents().length-1].getT())/2,_=new X(m,t.getEvents()[t.getEvents().length-1].getX());t.addEventAtEnd(_)},n));return l.prepend(r),e.appendChild(l),h.addEventListener("change",m=>{t.color=m.target.value,n.record()}),u.addEventListener("change",m=>{t.setName(m.target.value),n.record()}),c.addEventListener("change",m=>{t.setHeartbeats(m.target.checked),n.record()}),e}function Lt(n,t,e,s){const i=document.createElement("div");i.classList.add("trajectoryEventControlBlock");const h=`traj${t.num}-event${s}-`,a=document.createElement("label");a.classList.add("timeValue","grid-tVal"),a.innerHTML="<i>t</i> = ";const u=document.createElement("input");u.classList.add("coordInput"),u.type="number",u.step="any",u.value=T(e.getT(),n),a.append(u),i.append(a);const d=document.createElement("label");d.classList.add("posValue","grid-xVal"),d.innerHTML="<i>x</i> = ";const c=document.createElement("input");c.classList.add("coordInput"),c.type="number",c.step="any",c.value=T(e.getX(),n),d.append(c),i.append(d);const l=document.createElement("label");l.classList.add("timeValue","grid-tOVal"),l.innerHTML="<i>t</i>′ = ";const r=document.createElement("input");r.classList.add("coordInput"),r.type="number",r.step="any",r.value=T(n.getDiagram().getOtherFrame().otherT(e.getT(),e.getX()),n),l.append(r),i.append(l);const m=document.createElement("label");m.classList.add("posValue","grid-xOVal"),m.innerHTML="<i>x</i>′ = ";const _=document.createElement("input");_.classList.add("coordInput"),_.type="number",_.step="any",_.value=T(n.getDiagram().getOtherFrame().otherX(e.getT(),e.getX()),n),m.append(_),i.append(m);const v=document.createElement("input");v.classList.add("vModeLabel","grid-vIFixed"),v.setAttribute("aria-label","Fixed velocity value"),v.classList.add("vInMode"),v.type="radio",v.id=h+"vIn-fixed",v.name=h+"vIn-Mode",v.value="FIXED",s===0&&(v.disabled=!0),Number.isFinite(e.getVIn())?v.checked=!0:v.checked=!1,i.append(v);const V=document.createElement("label");V.classList.add("vInputLabel","grid-vIn"),V.innerHTML="<i>v</i><sub>in</sub> = ";const x=et();t.getSegments()[s]?x.value=T(t.getSegments()[s].getVFinal(),n):t.getSegments()[s+1]&&e.getVIn()==="SAME"?x.value=T(t.getSegments()[s+1].getVInitial(),n):x.value=null,v.checked?x.disabled=!1:x.disabled=!0,V.append(x),i.append(V);const I=document.createElement("label");I.classList.add("vInputLabel","grid-vOIn"),I.innerHTML="<i>v</i>′<sub>in</sub> = ";const H=et();t.getSegments()[s]?H.value=T(t.getSegments()[s].getOtherVFinal(n.getDiagram().getOtherFrame()),n):t.getSegments()[s+1]&&e.getVIn()==="SAME"?H.value=T(t.getSegments()[s+1].getOtherVInitial(n.getDiagram().getOtherFrame()),n):H.value=null,v.checked?H.disabled=!1:H.disabled=!0,I.append(H),i.append(I);const F=document.createElement("label");F.classList.add("vModeLabel","grid-vIAuto");const L=document.createElement("input");L.classList.add("vInMode"),L.type="radio",L.name=h+"vIn-Mode",L.value="AUTO",e.getVIn()==="AUTO"?L.checked=!0:L.checked=!1,F.append(L),s!==0?F.append("Auto"):F.append("None"),i.append(F);const N=document.createElement("label");N.classList.add("vModeLabel","grid-vIMatch");const M=document.createElement("input");M.classList.add("vInMode"),M.type="radio",M.name=h+"vIn-Mode",M.value="SAME",e.getVIn()==="SAME"?M.checked=!0:M.checked=!1,N.append(M),N.append("Match"),i.append(N);const b=document.createElement("input");b.classList.add("vModeLabel","grid-vOFixed"),b.setAttribute("aria-label","Fixed velocity value"),b.classList.add("vOutMode"),b.type="radio",b.id=h+"vOut-fixed",b.name=h+"vOut-Mode",b.value="FIXED",s===t.getEvents().length-1&&(b.disabled=!0),Number.isFinite(e.getVOut())?b.checked=!0:b.checked=!1,i.append(b);const G=document.createElement("label");G.classList.add("vInputLabel","grid-vOut"),G.innerHTML="<i>v</i><sub>out</sub> = ";const w=et();t.getSegments()[s+1]?w.value=T(t.getSegments()[s+1].getVInitial(),n):t.getSegments()[s]&&e.getVOut()==="SAME"?w.value=T(t.getSegments()[s].getVFinal(),n):w.value=null,b.checked?w.disabled=!1:w.disabled=!0,G.append(w),i.append(G);const D=document.createElement("label");D.classList.add("vInputLabel","grid-vOOut"),D.innerHTML="<i>v</i>′<sub>out</sub> = ";const E=et();t.getSegments()[s+1]?E.value=T(t.getSegments()[s+1].getOtherVInitial(n.getDiagram().getOtherFrame()),n):t.getSegments()[s]&&e.getVOut()==="SAME"?E.value=T(t.getSegments()[s].getOtherVFinal(n.getDiagram().getOtherFrame()),n):E.value=null,b.checked?E.disabled=!1:E.disabled=!0,D.append(E),i.append(D);const Z=document.createElement("label");Z.classList.add("vModeLabel","grid-vOAuto");const k=document.createElement("input");k.classList.add("vOutMode"),k.type="radio",k.name=h+"vOut-Mode",k.value="AUTO",e.getVOut()==="AUTO"?k.checked=!0:k.checked=!1,Z.append(k),s!==t.getEvents().length-1?Z.append("Auto"):Z.append("None"),i.append(Z);const Y=document.createElement("label");Y.classList.add("vModeLabel","grid-vOMatch");const P=document.createElement("input");if(P.classList.add("vOutMode"),P.type="radio",P.name=h+"vOut-Mode",P.value="SAME",e.getVOut()==="SAME"?P.checked=!0:P.checked=!1,Y.append(P),Y.append("Match"),i.append(Y),e.getVIn()==="HELP")i.classList.add("helperEvent"),u.disabled=!0,L.disabled=!0,M.disabled=!0,v.disabled=!0,x.disabled=!0,H.disabled=!0,r.disabled=!0,c.disabled=!0,k.disabled=!0,P.disabled=!0,b.disabled=!0,w.disabled=!0,E.disabled=!0,_.disabled=!0;else{const p=xt(O(()=>{if(t.getEvents().length===1)n.removeTrajectory(t.num),n.setSelected(null);else{const y=n.getSelected();t.removeEvent(s),y&&t.num===y.tNum&&(s===t.getUserEventNum(y.eNum)?n.setSelected(null):s<t.getUserEventNum(y.eNum)&&(y.eNum--,n.setSelected(y)))}},n));i.append(p);const U=document.createElement("div");U.classList.add("properTimeEvent");const R=document.createElement("input");R.classList.add("properTimeZero"),R.setAttribute("aria-label","Set proper time zero"),R.type="radio",R.id=h+"properTimeZero",R.name=`traj${t.num}-properTimeZero`,R.value=h+"tauZero",U.append(R),t.getProperTime(s)===0&&(R.checked=!0),R.addEventListener("change",O(t.setZeroTau.bind(t),n,s)),U.append("𝜏 = ");const z=document.createElement("output");z.classList.add("timeValue"),z.value=T(t.getProperTime(s),n,1e3),U.append(z),i.append(U)}return u.addEventListener("change",O(()=>{t.setEventCoords(s,u.valueAsNumber,c.valueAsNumber)},n)),c.addEventListener("change",O(()=>{t.setEventCoords(s,u.valueAsNumber,c.valueAsNumber)},n)),r.addEventListener("change",O(()=>{const p=n.getDiagram().getOtherFrame().homeT(r.valueAsNumber,_.valueAsNumber),U=n.getDiagram().getOtherFrame().homeX(r.valueAsNumber,_.valueAsNumber);t.setEventCoords(s,p,U)},n)),_.addEventListener("change",O(()=>{const p=n.getDiagram().getOtherFrame().homeT(r.valueAsNumber,_.valueAsNumber),U=n.getDiagram().getOtherFrame().homeX(r.valueAsNumber,_.valueAsNumber);t.setEventCoords(s,p,U)},n)),x.addEventListener("change",O(()=>{const p=x.valueAsNumber;if(p<=-1||p>=1){x.valueAsNumber=T(e.getVIn(),n);return}t.setEventVIn(s,p)},n)),H.addEventListener("change",O(()=>{const p=H.valueAsNumber;if(p<=-1||p>=1){H.valueAsNumber=T(n.getDiagram().getOtherFrame().otherV(e.getVIn()),n);return}t.setEventVIn(s,n.getDiagram().getOtherFrame().homeV(p))},n)),w.addEventListener("change",O(()=>{const p=w.valueAsNumber;if(p<=-1||p>=1){w.valueAsNumber=T(e.getVOut(),n);return}t.setEventVOut(s,p)},n)),E.addEventListener("change",O(()=>{const p=E.valueAsNumber;if(p<=-1||p>=1){E.valueAsNumber=T(n.getDiagram().getOtherFrame().otherV(e.getVOut()),n);return}t.setEventVOut(s,n.getDiagram().getOtherFrame().homeV(p))},n)),i.addEventListener("change",O(p=>{if(p.target.classList.contains("vInMode"))switch(p.target.value){case"FIXED":t.setEventVIn(s,x.valueAsNumber),x.disabled=!1,H.disabled=!1;break;case"AUTO":t.setEventVIn(s,"AUTO"),x.disabled=!0,H.disabled=!0;break;case"SAME":t.setEventVIn(s,"SAME"),x.disabled=!0,H.disabled=!0;break;default:K("Invalid velocity (in) mode",": default to AUTO."),L.checked=!0,x.disabled=!0,H.disabled=!0,t.setEventVIn(s,"AUTO")}else if(p.target.classList.contains("vOutMode"))switch(p.target.value){case"FIXED":t.setEventVOut(s,w.valueAsNumber),w.disabled=!1,E.disabled=!1;break;case"AUTO":t.setEventVOut(s,"AUTO"),w.disabled=!0,E.disabled=!0;break;case"SAME":t.setEventVOut(s,"SAME"),w.disabled=!0,E.disabled=!0;break;default:K("Invalid velocity (out) mode",": default to AUTO."),k.checked=!0,w.disabled=!0,E.disabled=!0,t.setEventVOut(s,"AUTO")}},n)),i}function tt(n,t,e,s){const i=document.createElement("div");if(i.classList.add("trajectorySegmentControlBlock"),s<t.getEvents().length&&t.getEvents()[s-1]&&t.getEvents()[s-1].getVIn()!=="HELP"){const h=ot(O(()=>{const a=n.getSelected();t.insertEventAfter(s-1),a&&t.num===a.tNum&&s-1<t.getUserEventNum(a.eNum)&&(a.eNum++,n.setSelected(a))},n));i.append(h)}if(e){const h=document.createElement("span");h.classList.add("accelInfo"),h.append(`𝛼 = ${T(e.getAccel(),n,1e4)}`),i.append(h)}return i}function mt(){const n=document.createElement("select");for(let t=0;t<S.length;t++){const e=document.createElement("option");e.value=S[t].color,e.textContent=S[t].name,n.appendChild(e)}return n}function gt(n=null){const t=document.createElement("input");return t.type="text",t.classList.add("symbolInput"),n!==null&&t.setAttribute("list",n),t}function et(){const n=document.createElement("input");return n.classList.add("vInput"),n.type="number",n.step="0.01",n.min="-0.99",n.max="0.99",n}function xt(n){const t=document.createElement("button");t.classList.add("eventCloseButton"),t.setAttribute("aria-label","Remove event");const e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("width","12"),s.setAttribute("height","12"),s.setAttribute("viewBox","0 0 12 12"),s.setAttribute("aria-hidden","true");const i=document.createElementNS(e,"line");i.setAttribute("x1","2"),i.setAttribute("y1","2"),i.setAttribute("x2","10"),i.setAttribute("y2","10"),i.setAttribute("stroke","currentColor"),i.setAttribute("stroke-width","2");const h=document.createElementNS(e,"line");return h.setAttribute("x1","10"),h.setAttribute("y1","2"),h.setAttribute("x2","2"),h.setAttribute("y2","10"),h.setAttribute("stroke","currentColor"),h.setAttribute("stroke-width","2"),s.appendChild(i),s.appendChild(h),t.appendChild(s),t.addEventListener("click",n),t}function ot(n){const t=document.createElement("button");return t.classList.add("addEventButton"),t.value="Add",t.textContent="Add event",t.addEventListener("click",n),t}function ft(n){let t,e;if(n.type.startsWith("touch"))if(n.touches.length>0)t=n.touches[0].clientX,e=n.touches[0].clientY;else return null;else t=n.clientX,e=n.clientY;const s=n.target.getBoundingClientRect();return{myX:t-s.left,myY:e-s.top}}function it(n,t){const e=ft(n);if(e===null)return;const s=e.myX,i=e.myY;let h;n.target.id!=="OtherCanvas"?h="home":h="other",t.ui.didDrag=!1;const a=t.findCloseEvent(s,i,h);t.setSelected(a),a!==null?(t.ui.isDragging=!0,t.ui.dragEvent=a,n.type.startsWith("touch")&&n.preventDefault(),t.ui.dragStart={x:s,y:i},t.ui.dragOffset.dx=s-a.canvasX,t.ui.dragOffset.dy=i-a.canvasY,ut(t)):document.getElementById("selectedEventControls").classList.add("invisible")}function st(n,t){if(!t.ui.isDragging||!t.ui.dragEvent)return;n.type.startsWith("touch")&&n.preventDefault();const e=ft(n);if(e===null)return;const s=e.myX,i=e.myY;let h;n.target.id!=="OtherCanvas"?h="home":h="other",Math.hypot(s-t.ui.dragStart.x,i-t.ui.dragStart.y)>Ct&&(t.ui.didDrag=!0);let u;n.shiftKey?u=null:u=.5*t.getStep();const{t:d,x:c}=t.getDiagram().toHomeCoords(s-t.ui.dragOffset.dx,i-t.ui.dragOffset.dy,h,u);if(!Number.isFinite(t.ui.dragEvent.tNum))t.moveLoneEvent(t.ui.dragEvent.eNum,d,c);else{const l=t.getTrajectories()[t.ui.dragEvent.tNum];l.setEventCoords(l.getUserEventNum(t.ui.dragEvent.eNum),d,c)}ut(t),t.redraw()}function W(n,t){if(!(!t.ui.isDragging||!t.ui.dragEvent)){if(t.ui.isDragging=!1,!t.ui.didDrag)if(!Number.isFinite(t.ui.dragEvent.tNum))t.moveLoneEvent(t.ui.dragEvent.eNum,t.ui.dragEvent.origCoords.t,t.ui.dragEvent.origCoords.x);else{const e=t.getTrajectories()[t.ui.dragEvent.tNum];e.setEventCoords(e.getUserEventNum(t.ui.dragEvent.eNum),t.ui.dragEvent.origCoords.t,t.ui.dragEvent.origCoords.x)}t.ui.dragEvent=null,t.update()}}function ut(n){const t=n.getSelected();if(!t){document.getElementById("selectedEventControls").classList.add("invisible");return}const e=document.getElementById("selectedT"),s=document.getElementById("selectedX"),i=document.getElementById("selectedTO"),h=document.getElementById("selectedXO"),a=document.getElementById("selectedName");if(!Number.isFinite(t.tNum))a.value=n.getLoneEvents()[t.eNum].symbol,document.getElementById("selectedEventControls").style.borderColor=n.getLoneEvents()[t.eNum].color,e.valueAsNumber=n.getLoneEvents()[t.eNum].t,s.valueAsNumber=n.getLoneEvents()[t.eNum].x,i.valueAsNumber=n.getDiagram().getOtherFrame().otherT(n.getLoneEvents()[t.eNum].t,n.getLoneEvents()[t.eNum].x),h.valueAsNumber=n.getDiagram().getOtherFrame().otherX(n.getLoneEvents()[t.eNum].t,n.getLoneEvents()[t.eNum].x),document.querySelectorAll("#selectedEventControls .hideIfLone").forEach(u=>{u.classList.add("invisible")});else{const u=document.getElementById("selectedVIn"),d=document.getElementById("selectedVInO"),c=document.getElementById("selectedVOut"),l=document.getElementById("selectedVOutO"),r=document.getElementById("selected-vIn-auto"),m=document.getElementById("selected-vIn-same"),_=document.getElementById("selected-vIn-fixed"),v=document.getElementById("selected-vOut-auto"),V=document.getElementById("selected-vOut-same"),x=document.getElementById("selected-vOut-fixed"),I=document.getElementById("selected-properTimeZero"),H=document.getElementById("selectedTau"),F=n.getTrajectories()[t.tNum],L=F.getUserEventNum(t.eNum),N=F.getEvents()[L],M=F.getSegments()[L],b=F.getSegments()[L+1];a.value=F.getName(),document.getElementById("selectedEventControls").style.borderColor=F.color,e.valueAsNumber=N.getT(),s.valueAsNumber=N.getX(),i.valueAsNumber=n.getDiagram().getOtherFrame().otherT(N.getT(),N.getX()),h.valueAsNumber=n.getDiagram().getOtherFrame().otherX(N.getT(),N.getX()),M?(u.valueAsNumber=T(M.getVFinal(),n),d.valueAsNumber=T(M.getOtherVFinal(n.getDiagram().getOtherFrame()),n)):b&&N.getVIn()==="SAME"?(u.valueAsNumber=T(b.getVInitial(),n),d.valueAsNumber=T(b.getOtherVInitial(n.getDiagram().getOtherFrame()),n)):(u.value=null,d.value=null),b?(c.valueAsNumber=T(b.getVInitial(),n),l.valueAsNumber=T(b.getOtherVInitial(n.getDiagram().getOtherFrame()),n)):M&&N.getVOut()==="SAME"?(c.valueAsNumber=T(M.getVFinal(),n),l.valueAsNumber=T(M.getOtherVFinal(n.getDiagram().getOtherFrame()),n)):(c.value=null,l.value=null),Number.isFinite(N.getVIn())?(_.checked=!0,u.disabled=!1,d.disabled=!1):N.getVIn()==="SAME"?(m.checked=!0,u.disabled=!0,d.disabled=!0):(r.checked=!0,u.disabled=!0,d.disabled=!0),Number.isFinite(N.getVOut())?(x.checked=!0,c.disabled=!1,l.disabled=!1):N.getVOut()==="SAME"?(V.checked=!0,c.disabled=!0,l.disabled=!0):(v.checked=!0,c.disabled=!0,l.disabled=!0),L===0?_.disabled=!0:_.disabled=!1,L===F.getUserEvents().length-1?x.disabled=!0:x.disabled=!1,H.value=T(F.getProperTime(L),n,1e3),F.getProperTime(L)===0?I.checked=!0:I.checked=!1,document.querySelectorAll("#selectedEventControls .hideIfLone").forEach(G=>{G.classList.remove("invisible")})}document.getElementById("selectedEventControls").classList.remove("invisible")}class at{constructor(t,e,s="black",i=!1,h=!0){t?this._name=String(t):this._name="",Array.isArray(e)?this._events=e:this._events=[e],this._userEvents=[0],this._segments=[],this._zeroEvent=0,this._properTimes=[0],this._minTau=0,this._maxTau=0,this.color=s,this.smooth=i,this.showHeartbeats=h,this.num=null}getName(){return this._name}setName(t){this._name=t}setHeartbeats(t){this.showHeartbeats=t}_rebuildSegments(){this._segments=[];const t=[],e=[];let s=[];for(let h=this._events.length-1;h>=0;h--)this._events[h].getVIn()==="HELP"&&this._events.splice(h,1);Number.isFinite(this._events[0].getVIn())?(t[0]=this._events[0].getVIn(),e[0]=this._events[0].getVOut(),e[0]==="SAME"&&(e[0]=t[0])):(t[0]="NONE",e[0]=this._events[0].getVOut(),e[0]==="SAME"&&(e[0]="AUTO"));for(let h=1;h<this._events.length-1;h++){if(t[h]=this._events[h].getVIn(),e[h]=this._events[h].getVOut(),this.smooth&&Number.isFinite(t[h])&&Number.isFinite(e[h])){const a=Math.tanh((Math.atanh(t[h])+Math.atanh(e[h]))/2);t[h]=a,e[h]=a}t[h]==="SAME"&&e[h]==="SAME"&&(t[h]="AUTO",e[h]="AUTO",s.push(h)),this.smooth&&t[h]==="AUTO"&&e[h]==="AUTO"&&s.push(h),Number.isFinite(e[h])&&(t[h]==="SAME"||this.smooth&&t[h]==="AUTO")&&(t[h]=e[h]),Number.isFinite(t[h])&&(e[h]==="SAME"||this.smooth&&e[h]==="AUTO")&&(e[h]=t[h])}Number.isFinite(this._events[this._events.length-1].getVOut())?(e[this._events.length-1]=this._events[this._events.length-1].getVOut(),t[this._events.length-1]=this._events[this._events.length-1].getVIn(),t[this._events.length-1]==="SAME"&&(t[this._events.length-1]=e[this._events.length-1])):(e[this._events.length-1]="NONE",t[this._events.length-1]=this._events[this._events.length-1].getVIn(),t[this._events.length-1]==="SAME"&&(t[this._events.length-1]="AUTO"));let i=0;for(;this._events[i+1];){if(this._segments[i+1]){i++;continue}const h=this._events[i+1].getT()-this._events[i].getT(),a=this._events[i+1].getX()-this._events[i].getX();if(h<=Math.abs(a)){if(this._segments[i+1]=new J(this._events[i],this._events[i+1]),e[i]=this._segments[i+1].vOfTau(0),t[i+1]=e[i],e[i+1]==="SAME"&&(e[i+1]="AUTO"),t[i]==="SAME"){t[i]="AUTO",i--;continue}}else if(Number.isFinite(e[i])&&Number.isFinite(t[i+1])){i++;continue}else if(t[i+1]==="SAME"){i++;continue}else if(j(e[i])&&Number.isFinite(t[i+1])){if(this._segments[i+1]=q(this._events[i],this._events[i+1],"AUTO",t[i+1]),e[i]=this._segments[i+1].getVInitial(),t[i]==="SAME"){t[i]=e[i],i--;continue}}else if(Number.isFinite(e[i])&&j(t[i+1]))this._segments[i+1]=q(this._events[i],this._events[i+1],e[i],"AUTO"),t[i+1]=this._segments[i+1].getVFinal(),e[i+1]==="SAME"&&(e[i+1]=t[i+1]);else if(this._segments[i+1]=new J(this._events[i],this._events[i+1]),e[i]=this._segments[i+1].vOfTau(0),t[i+1]=e[i],e[i+1]==="SAME"&&(e[i+1]=t[i+1]),t[i]==="SAME"){t[i]=e[i],i--;continue}i++}s.forEach(h=>{const a=Math.tanh((Math.atanh(t[h])+Math.atanh(e[h]))/2);t[h]=a,e[h]=a,this._segments[h]=void 0,this._segments[h+1]=void 0,j(this._events[h-1].getVOut())&&this._events[h-1].getVIn()!=="SAME"&&(this._segments[h]=q(this._events[h-1],this._events[h],"AUTO",a)),j(this._events[h+1].getVIn())&&this._events[h+1].getVOut()!=="SAME"&&(this._segments[h+1]=q(this._events[h],this._events[h+1],a,"AUTO"))});for(let h=this._events.length-1;h>0;h--)if(!this._segments[h]){let a=this._events[h].getT()-this._events[h-1].getT(),u=this._events[h].getX()-this._events[h-1].getX();if(Math.abs(e[h-1]-u/a)<ht&&Math.abs(t[h]-u/a)<ht){this._segments[h]=new J(this._events[h-1],this._events[h]);continue}const d=Math.tanh(.5*Math.atanh(e[h-1])),c=Math.tanh(.5*Math.atanh(t[h])),l=u/a;let r;Math.abs(d+c-2*l*d*c)<ht?r=(l-.5*d-.5*c)/(1+d*c-l*(d+c)):r=(-(1+d*c-l*(d+c))+Math.sqrt((1+d*c-l*(d+c))**2-(d+c-2*l*d*c)*(d+c-2*l)))/(d+c-2*l*d*c);const m=this._events[h-1].getT()+.5*a,_=this._events[h-1].getX()+.5*a*(d+r)/(1+d*r),v=new X(m,_,"HELP","HELP");this._events.splice(h,0,v),t.splice(h,0,"AUTO"),e.splice(h,0,"AUTO"),this._segments[h]=q(this._events[h-1],this._events[h],e[h-1],"AUTO"),this._segments.splice(h+1,0,q(this._events[h],this._events[h+1],"AUTO",t[h+1]))}this._segments[1]&&this._events[0].getVIn()==="SAME"&&this._segments[1].setExtrapI(!0),this._segments[this._events.length-1]&&this._events[this._events.length-1].getVOut()==="SAME"&&this._segments[this._events.length-1].setExtrapF(!0),this._userEvents=[];for(let h=0;h<this._events.length;h++)this._events[h].num=h,this._events[h]._vIn!=="HELP"&&this._userEvents.push(h),this._segments[h]&&(this._segments[h].num=h);this._segments[this._events.length]&&(this._segments[this._events.length].num=this._events.length),this._setProperTimes()}_setProperTimes(){this._properTimes=[0];const t=this._userEvents[this._zeroEvent];this._properTimes[t]=0;for(let e=t+1;e<this._events.length;e++)this._properTimes[e]=this._properTimes[e-1]+this._segments[e].tauAtFrac(1);for(let e=t-1;e>=0;e--)this._properTimes[e]=this._properTimes[e+1]-this._segments[e+1].tauAtFrac(1);if(this._segments.length>0){const e=[this._properTimes[this._events.length-1],this._segments[this._segments.length-1].tauOfT(Number.POSITIVE_INFINITY),this._segments[this._segments.length-1].tauOfT(Number.NEGATIVE_INFINITY)].filter(i=>i!==!1);this._maxTau=Math.max(...e);const s=[this._properTimes[0],this._segments[1].tauOfT(Number.POSITIVE_INFINITY),this._segments[1].tauOfT(Number.NEGATIVE_INFINITY)].filter(i=>i!==!1);this._minTau=Math.min(...s)}else this._maxTau=0,this._minTau=0}getProperTime(t){return this._properTimes[t]}setZeroTau(t){const e=this._userEvents.indexOf(t);this._zeroEvent=B("Event",e,0,this._userEvents.length-1),this._setProperTimes()}addEventAtEnd(t){this._events.push(t),this._rebuildSegments()}addEventAtStart(t){this._events.unshift(t),this._zeroEvent++,this._rebuildSegments()}insertEventAfter(t,e="AUTO"){if(t<0||t>=this._events.length-1)throw new RangeError(`No segment to split after event ${t}.`);if(e instanceof X||(e="AUTO"),this._events[t].getVIn()==="HELP")e==="AUTO"?(this._events[t].setVIn("AUTO"),this._events[t].setVOut("AUTO")):this._events[t]=e;else if(this._events[t+1].getVIn()==="HELP")e==="AUTO"?(this._events[t+1].setVIn("AUTO"),this._events[t+1].setVOut("AUTO")):this._events[t+1]=e;else{if(e==="AUTO"){const s=this._segments[t+1].tauAtFrac(.5),i=this._segments[t+1].tOfTau(s),h=this._segments[t+1].xOfTau(s);this._events[t].getVOut()==="AUTO"?this._events[t+1].getVIn()==="AUTO"?e=new X(i,h,"AUTO","AUTO"):e=new X(i,h,"SAME","AUTO"):e=new X(i,h,"AUTO","SAME")}this._events.splice(t+1,0,e),this._userEvents.indexOf(t)<this._zeroEvent&&this._zeroEvent++}this._rebuildSegments()}insertEventBefore(t,e="AUTO"){if(t<1||t>this._events.length-1)throw new RangeError(`No segment to split before event ${t}.`);if(e instanceof X||(e="AUTO"),this._events[t].getVIn()==="HELP")e==="AUTO"?(this._events[t].setVIn("AUTO"),this._events[t].setVOut("AUTO")):this._events[t]=e;else if(this._events[t-1].getVIn()==="HELP")e==="AUTO"?(this._events[t-1].setVIn("AUTO"),this._events[t-1].setVOut("AUTO")):this._events[t-1]=e;else{if(e==="AUTO"){const s=this._segments[t].tauAtFrac(.5),i=this._segments[t].tOfTau(s),h=this._segments[t].xOfTau(s);this._events[t].getVIn()==="AUTO"?this._events[t-1].getVOut()==="AUTO"?e=new X(i,h,"AUTO","AUTO"):e=new X(i,h,"AUTO","SAME"):e=new X(i,h,"SAME","AUTO")}this._events.splice(t,0,e),this._userEvents.indexOf(t)<=this._zeroEvent&&this._zeroEvent++}this._rebuildSegments()}removeEvent(t){if(!Number.isInteger(t)||t<0||t>=this._events.length)throw new RangeError(`No event number ${t}.`);this._events.splice(t,1),(this._userEvents.indexOf(t)<this._zeroEvent||this._userEvents.indexOf(t)===this._zeroEvent&&this._userEvents.indexOf(t)===this._events.length&&this._userEvents.indexOf(t)>0)&&this._zeroEvent--,this._rebuildSegments()}setEventCoords(t,e,s){if(!Number.isInteger(t)||t<0||t>=this._events.length)throw new RangeError(`No event number ${t}.`);if(this._events[t].getVIn()==="HELP")throw new Error("Can't set coordinates for a helper event!");this._events[t].setCoords(e,s),this._rebuildSegments()}setEventVIn(t,e){if(!Number.isInteger(t)||t<0||t>=this._events.length)throw new RangeError(`No event number ${t}.`);if(this._events[t].getVIn()==="HELP")throw new Error("Can't set velocities for a helper event!");this._events[t].setVIn(e),this._rebuildSegments()}setEventVOut(t,e){if(!Number.isInteger(t)||t<0||t>=this._events.length)throw new RangeError(`No event number ${t}.`);if(this._events[t].getVIn()==="HELP")throw new Error("Can't set velocities for a helper event!");this._events[t].setVOut(e),this._rebuildSegments()}getSegmentAtTau(t){if(t<this._properTimes[0]&&this._segments[1].getExtrapI())return 1;if(t>this._properTimes[this._properTimes.length-1]&&this._segments[this._segments.length-1].getExtrapF())return this._segments.length-1;if(t<=this._properTimes[0]&&t>=this._properTimes[0]-9e-4*this._segments[1].tauAtFrac(1))return 1;if(t>this._properTimes[this._properTimes.length-1]&&t<this._properTimes[this._properTimes.length-1]+9e-4*this._segments[this._properTimes.length-1].tauAtFrac(1))return this._properTimes.length;let e=this._properTimes.findIndex(s=>t<=s);return e===-1?this._events.length:e}getSegmentsAtT(t){const e=[];return this._segments.forEach((s,i)=>{s.includesT(t)&&e.push(i)}),e}getXsAtT(t){return new Set(this._segments.map(e=>e.xOfT(t)).filter(e=>Number.isFinite(e)))}getXTypesAtT(t){return new Set(this._segments.map(e=>({x:e.xOfT(t),type:e.type(),tau:e.tauOfT(t)+this._properTimes[e.num-1]})).filter(e=>{if(Number.isFinite(e.x))return e}))}getXsAtTOther(t,e){return new Set(this._segments.map(s=>s.xOfTOther(t,e)).filter(s=>Number.isFinite(s)))}getXTypesAtTOther(t,e){return new Set(this._segments.map(s=>({x:s.xOfTOther(t,e),type:s.type(),tau:s.tauOfTOther(t,e)+this._properTimes[s.num-1]})).filter(s=>{if(Number.isFinite(s.x))return s}))}tOfTau(t){if(t=B("Proper time",t,this._minTau,this._maxTau),this._events.length===1)return this._events[0].getT();const e=this.getSegmentAtTau(t);return this._segments[e].tOfTau(t-this._properTimes[e-1])}xOfTau(t){if(t=B("Proper time",t,this._minTau,this._maxTau,": default to start."),this._events.length===1)return this._events[0].getX();const e=this.getSegmentAtTau(t);return this._segments[e].xOfTau(t-this._properTimes[e-1])}vOfTau(t){if(t=B("Proper time",t,this._minTau,this._maxTau),this._events.length===1)return 0;const e=this.getSegmentAtTau(t);return this._segments[e].vOfTau(t-this._properTimes[e-1])}vOtherOfTau(t,e){if(t=B("Proper time",t,this._minTau,this._maxTau),this._events.length===1)return 0;const s=this.getSegmentAtTau(t);return this._segments[s].vOtherOfTau(t-this._properTimes[s-1],e)}heartbeats(t,e=1,s,i){if(!this.showHeartbeats||this._segments.length===0)return[];const h=[this._properTimes[this._events.length-1],this._segments[this._segments.length-1].tauOfT(i),this._segments[this._segments.length-1].tauOfT(s)].filter(l=>l!==!1),a=Math.max(...h),u=[this._properTimes[0],this._segments[1].tauOfT(i),this._segments[1].tauOfT(s)].filter(l=>l!==!1),d=Math.min(...u),c=[];for(let l=0;l<=a;l+=e)c.push({t:this.tOfTau(l),x:this.xOfTau(l),v:this.vOfTau(l),vO:this.vOtherOfTau(l,t)});for(let l=-e;l>=d;l-=e)c.unshift({t:this.tOfTau(l),x:this.xOfTau(l),v:this.vOfTau(l),vO:this.vOtherOfTau(l,t)});return c}getEvents(){return[...this._events]}getSegments(){return[...this._segments]}getUserEvents(){return[...this._userEvents]}getUserEventNum(t){return this._userEvents[t]}serialize(t=!0){const e={};if(e.n=this._name,this._zeroEvent!==0&&(e.t0=this._zeroEvent),e.ev=this._events.filter(s=>s.getVIn()!=="HELP").map(s=>s.serialize()),this.color!=="black"){const s=S.findIndex(i=>i.color===this.color);s>=0&&(e.c=s)}return this.smooth!==!1&&(e.sm=this.smooth),this.showHeartbeats!==t&&(e.hb=0),e}static fromSerialized(t,e=!0){t.sm===void 0&&(t.sm=!1),t.hb===void 0&&(t.hb=e),t.hb===0&&(t.hb=!e),Number.isInteger(t.c)&&t.c>=0&&t.c<S.length?t.color=S[t.c].color:t.color=S[0].color;const s=new at(t.n,t.ev.map(i=>X.fromSerialized(i)),t.color,t.sm,t.hb);return s._rebuildSegments(),t.t0!==void 0&&s.setZeroTau(t.t0),s}}const nt=.5,Mt=12;class kt{constructor(t){this._diagram=t,this._trajectories=[],this._loneEvents=[],this._timeslice=null,this._units="",this.setUnits("s"),{minT:this._minT,maxT:this._maxT,step:this._step}=t.getCoordRange(),this._animTime=(this._maxT-this._minT)/this._step,this._animFrame=null,this._animStart=null,this._animPause=1,this._timesliceControl=document.getElementById("TimesliceValue"),this._boundAnimate=this._animate.bind(this),this._undoHistory=[],this._undoIndex=0,this._undoTimeout=null,this._selectedEvent=null,this.ui={isDragging:!1,dragStart:{x:0,y:0},dragOffset:{dx:0,dy:0},didDrag:!1,dragEvent:null},this._buildTrajectoryWrappers(["getName","setName","setZeroTau","addEventAtEnd","addEventAtStart","insertEventAfter","insertEventBefore","removeEvent","getEvents"])}_buildTrajectoryWrappers(t){for(const e of t)this[e]=(s,...i)=>{if(!Number.isFinite(s)||s<0||s>=this._trajectories.length){$(`There is no trajectory #${s}`,": not doing anything.");return}const h=this._trajectories[s][e](...i);return this.update(),h}}setOtherVel(t){this._diagram.setFrameBeta(t),this.update()}setHeartbeatStep(t){this._diagram.setHeartbeatStep(t),this.record()}setUnits(t){this._units=t,document.querySelectorAll(".timeValue, .posValue, .accelInfo, .velInfoExplicit").forEach(e=>{e.dataset.unit=t})}getDiagram(){return this._diagram}getLoneEvents(){return this._loneEvents}getTrajectories(){return this._trajectories}getMinT(){return this._diagram.getCoordRange().minT}getMaxT(){return this._diagram.getCoordRange().maxT}getStep(){return this._diagram.getCoordRange().step}addLoneEvent(t,e,s="",i=null){(!Number.isInteger(i)||i<0||i>=S.length)&&(i=this._loneEvents.length%S.length),this._loneEvents.push({t,x:e,symbol:s,color:S[i].color,num:this._loneEvents.length}),this.update()}removeLoneEvent(t){this._loneEvents.splice(t,1),this.update()}moveLoneEvent(t,e,s){this._loneEvents[t].t=e,this._loneEvents[t].x=s,this.record()}renameLoneEvent(t,e){this._loneEvents[t].symbol=e,this.record()}recolorLoneEvent(t,e){Number.isInteger(this.colorNum)&&e>=0&&e<S.length&&(this._loneEvents[t].color=S[e].color),this.record()}addTrajectory(t="",e=!1,s=null,i=!0){(!Number.isInteger(s)||s<0||s>=S.length)&&(s=this._trajectories.length%S.length),e||(e=new X(0,0)),this._trajectories.push(new at(t,e,S[s].color,!1,i)),this.update()}removeTrajectory(t){if(!Number.isInteger(t)||t<0||t>=this._trajectories.length){$(`There is no trajectory #${t}`,": nothing to remove.");return}this._trajectories.splice(t,1)}setTimeslice(t){Number.isFinite(t)?this._timeslice=t:this._timeslice=null,this._diagram.setTimeslice(t),this.redraw()}update(){this.record();for(let t=0;t<this._loneEvents.length;t++)this._loneEvents[t].num=t;for(let t=0;t<this._trajectories.length;t++)this._trajectories[t].num=t;document.getElementById("FrameBeta")&&(dt(this),_t(this),St(this)),this.setUnits(this._units)}record(){this.redraw(),this.ui.isDragging||(lt(this),this.scheduleUndoSnapshot())}redraw(){this._diagram.redraw(),this._diagram.clearAnims(),this._trajectories.forEach(t=>{this._diagram.drawTrajectory(t),this._timeslice!==null&&this._diagram.drawAnimPoints(t.getXTypesAtT(this._timeslice),t.getXTypesAtTOther(this._timeslice,this._diagram.getOtherFrame()),t.color,t.getName(),t.showHeartbeats)}),this._loneEvents.forEach(t=>{if(this._diagram.drawLoneEvent(t),this._timeslice!==null){const e=this._diagram.getOtherFrame().otherT(t.t,t.x),s=this._diagram.getOtherFrame().otherX(t.t,t.x);if(this._timeslice>=t.t&&this._timeslice<t.t+nt*this._step){const i=1-(this._timeslice-t.t)/(nt*this._step);this._diagram.drawHomeAnimLoneEvent(t,i)}if(this._timeslice>=e&&this._timeslice<e+nt*this._step){const i=1-(this._timeslice-e)/(nt*this._step);this._diagram.drawOtherAnimLoneEvent(s,t.symbol,t.color,i)}}}),this._diagram.replicateAnim(),this._selectedEvent!==null&&(this._selectedEvent.tNum===Number.POSITIVE_INFINITY?this._diagram.highlightEvent({t:this._loneEvents[this._selectedEvent.eNum].t,x:this._loneEvents[this._selectedEvent.eNum].x}):this._diagram.highlightEvent(this._trajectories[this._selectedEvent.tNum].getEvents()[this._trajectories[this._selectedEvent.tNum].getUserEventNum(this._selectedEvent.eNum)].getCoords()))}startMotion(){({minT:this._minT,maxT:this._maxT,step:this._step}=this._diagram.getCoordRange()),this._timeslice===null&&(this._timeslice=this._minT),this._animFrame=window.requestAnimationFrame(this._boundAnimate)}_animate(t){if({minT:this._minT,maxT:this._maxT,step:this._step}=this._diagram.getCoordRange(),this._animTime=(this._maxT-this._minT)/this._step,this._animStart===null){const s=(this._timeslice-this._minT)/(this._maxT-this._minT);this._animStart=t-s*this._animTime*1e3}const e=(t-this._animStart)/1e3;if(e<=this._animTime+this._animPause){const s=Math.min(this._animTime,e)/this._animTime;this.setTimeslice(this._minT+s*(this._maxT-this._minT))}else this._animStart=t,this.setTimeslice(this._minT);this._timesliceControl&&(this._timesliceControl.value=Math.round(this._timeslice*100)/100),this._animFrame=window.requestAnimationFrame(this._boundAnimate)}pauseMotion(){this._animFrame!==null&&(window.cancelAnimationFrame(this._animFrame),this._animFrame=null,this._animStart=null)}cancelMotion(){this.pauseMotion(),this.setTimeslice(null)}exportState(){const e=this._loneEvents.map(i=>[Math.round(i.t*1e4)/1e4,Math.round(i.x*1e4)/1e4,i.symbol,S.findIndex(h=>h.color===i.color)]),s=this._diagram.getCoordRange();return delete s.maxX,s.minXAuto&&delete s.minX,{lone:e,trajs:this._trajectories.map(i=>i.serialize()),tRange:s,oHide:this._diagram.getOtherHidden(),hstep:this._diagram.getHeartbeatStep(),unit:this._units,beta:this._diagram.getOtherFrame().getBeta()}}importState(t){this._selectedEvent=null;const e=document.getElementById("selectedEventControls");e&&e.classList.add("invisible");let s=!0;t.hbd===0&&(s=!1),this._loneEvents=t.lone.map(i=>({t:i[0],x:i[1],symbol:i[2],color:S[i[3]].color})),this._trajectories=t.trajs.map(i=>at.fromSerialized(i,s)),t.oHide?this._diagram.setOtherHidden(!0):this._diagram.setOtherHidden(!1),t.tRange.minXAuto?this._diagram.setCoordRange(t.tRange.minT,t.tRange.maxT,t.tRange.step):this._diagram.setCoordRange(t.tRange.minT,t.tRange.maxT,t.tRange.step,t.tRange.minX),this._diagram.setHeartbeatStep(t.hstep),this.setOtherVel(t.beta),{minT:this._minT,maxT:this._maxT,step:this._step}=t.tRange,t.unit&&this.setUnits(t.unit),this.update()}scheduleUndoSnapshot(){clearTimeout(this._undoTimeout),this._undoTimeout=setTimeout(()=>{this._saveUndoState(),this._undoTimeout=null},400)}_saveUndoState(){const e=JSON.stringify(this.exportState());this._undoHistory[this._undoIndex]!==e&&(this._undoIndex<40?(this._undoIndex++,this._undoHistory.length=this._undoIndex):this._undoHistory.splice(0,1),this._undoHistory[this._undoIndex]=e,document.getElementById("UndoButton").disabled=!1,document.getElementById("RedoButton").disabled=!0)}undo(){this._undoTimeout!==null&&(clearTimeout(this._undoTimeout),this._saveUndoState(),this._undoTimeout=null),this._undoIndex>0&&(this._undoIndex--,this.importState(JSON.parse(this._undoHistory[this._undoIndex])),document.getElementById("RedoButton").disabled=!1),this._undoIndex<=0&&(document.getElementById("UndoButton").disabled=!0)}redo(){this._undoIndex<this._undoHistory.length-1&&(this._undoIndex++,this.importState(JSON.parse(this._undoHistory[this._undoIndex]))),this._undoIndex>=this._undoHistory.length-1&&(document.getElementById("RedoButton").disabled=!0)}isUndoAllowed(){return this._undoIndex>0}isRedoAllowed(){return this._undoIndex<this._undoHistory.length-1}findCloseEvent(t,e,s="home"){const i=[];for(let h=0;h<this._trajectories.length;h++){const a=this._trajectories[h].getUserEvents();for(let u=0;u<a.length;u++){const d=a[u];let c,l;s!=="other"?{px:c,py:l}=this._diagram.toCanvasCoordsP(this._trajectories[h].getEvents()[d].getCoords()):{px:c,py:l}=this._diagram.toOtherCanvasCoordsP(this._trajectories[h].getEvents()[d].getCoords()),i.push({tNum:h,eNum:u,canvasX:c,canvasY:l,origCoords:this._trajectories[h].getEvents()[d].getCoords(),dist:Math.hypot(t-c,e-l)})}}for(let h=0;h<this._loneEvents.length;h++){let a,u;s!=="other"?{px:a,py:u}=this._diagram.toCanvasCoordsP({t:this._loneEvents[h].t,x:this._loneEvents[h].x}):{px:a,py:u}=this._diagram.toOtherCanvasCoordsP({t:this._loneEvents[h].t,x:this._loneEvents[h].x}),i.push({tNum:Number.POSITIVE_INFINITY,eNum:h,canvasX:a,canvasY:u,origCoords:{t:this._loneEvents[h].t,x:this._loneEvents[h].x},dist:Math.hypot(t-a,e-u)})}return i.sort((h,a)=>Math.abs(h.dist-a.dist)>1?h.dist-a.dist:h.tNum!==a.tNum?a.tNum-h.tNum:a.eNum-h.eNum),i[0]&&i[0].dist<Mt?i[0]:null}setSelected(t){this._selectedEvent=t,this.redraw()}getSelected(){return this._selectedEvent}}export{Xt as B,wt as C,Ft as D,kt as S,Bt as s};
